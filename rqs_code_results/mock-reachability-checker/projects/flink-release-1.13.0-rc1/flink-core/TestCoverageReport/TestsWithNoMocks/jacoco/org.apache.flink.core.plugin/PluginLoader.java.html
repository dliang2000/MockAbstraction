<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PluginLoader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Flink : Core</a> &gt; <a href="index.source.html" class="el_package">org.apache.flink.core.plugin</a> &gt; <span class="el_source">PluginLoader.java</span></div><h1>PluginLoader.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.flink.core.plugin;

import org.apache.flink.annotation.VisibleForTesting;
import org.apache.flink.util.ArrayUtils;
import org.apache.flink.util.TemporaryClassLoaderContext;

import javax.annotation.concurrent.ThreadSafe;

import java.io.IOException;
import java.net.URL;
import java.net.URLClassLoader;
import java.util.Arrays;
import java.util.Enumeration;
import java.util.Iterator;
import java.util.ServiceLoader;

/**
 * A {@link PluginLoader} is used by the {@link PluginManager} to load a single plugin. It is
 * essentially a combination of a {@link PluginClassLoader} and {@link ServiceLoader}. This class
 * can locate and load service implementations from the plugin for a given SPI. The {@link
 * PluginDescriptor}, which among other information contains the resource URLs, is provided at
 * construction.
 */
@ThreadSafe
public class PluginLoader {

    /**
     * Classloader which is used to load the plugin classes. We expect this classloader is
     * thread-safe.
     */
    private final ClassLoader pluginClassLoader;

    @VisibleForTesting
<span class="nc" id="L52">    public PluginLoader(ClassLoader pluginClassLoader) {</span>
<span class="nc" id="L53">        this.pluginClassLoader = pluginClassLoader;</span>
<span class="nc" id="L54">    }</span>

    @VisibleForTesting
    public static ClassLoader createPluginClassLoader(
            PluginDescriptor pluginDescriptor,
            ClassLoader parentClassLoader,
            String[] alwaysParentFirstPatterns) {
<span class="nc" id="L61">        return new PluginClassLoader(</span>
<span class="nc" id="L62">                pluginDescriptor.getPluginResourceURLs(),</span>
                parentClassLoader,
<span class="nc" id="L64">                ArrayUtils.concat(</span>
<span class="nc" id="L65">                        alwaysParentFirstPatterns, pluginDescriptor.getLoaderExcludePatterns()));</span>
    }

    public static PluginLoader create(
            PluginDescriptor pluginDescriptor,
            ClassLoader parentClassLoader,
            String[] alwaysParentFirstPatterns) {
<span class="nc" id="L72">        return new PluginLoader(</span>
<span class="nc" id="L73">                createPluginClassLoader(</span>
                        pluginDescriptor, parentClassLoader, alwaysParentFirstPatterns));
    }

    /**
     * Returns in iterator over all available implementations of the given service interface (SPI)
     * for the plugin.
     *
     * @param service the service interface (SPI) for which implementations are requested.
     * @param &lt;P&gt; Type of the requested plugin service.
     * @return An iterator of all implementations of the given service interface that could be
     *     loaded from the plugin.
     */
    public &lt;P&gt; Iterator&lt;P&gt; load(Class&lt;P&gt; service) {
<span class="nc" id="L87">        try (TemporaryClassLoaderContext ignored =</span>
<span class="nc" id="L88">                TemporaryClassLoaderContext.of(pluginClassLoader)) {</span>
<span class="nc" id="L89">            return new ContextClassLoaderSettingIterator&lt;&gt;(</span>
<span class="nc" id="L90">                    ServiceLoader.load(service, pluginClassLoader).iterator(), pluginClassLoader);</span>
        }
    }

    /**
     * Wrapper for the service iterator. The wrapper will set/unset the context classloader to the
     * plugin classloader around the point where elements are returned.
     *
     * @param &lt;P&gt; type of the iterated plugin element.
     */
    static class ContextClassLoaderSettingIterator&lt;P&gt; implements Iterator&lt;P&gt; {

        private final Iterator&lt;P&gt; delegate;
        private final ClassLoader pluginClassLoader;

<span class="nc" id="L105">        ContextClassLoaderSettingIterator(Iterator&lt;P&gt; delegate, ClassLoader pluginClassLoader) {</span>
<span class="nc" id="L106">            this.delegate = delegate;</span>
<span class="nc" id="L107">            this.pluginClassLoader = pluginClassLoader;</span>
<span class="nc" id="L108">        }</span>

        @Override
        public boolean hasNext() {
<span class="nc" id="L112">            return delegate.hasNext();</span>
        }

        @Override
        public P next() {
<span class="nc" id="L117">            try (TemporaryClassLoaderContext ignored =</span>
<span class="nc" id="L118">                    TemporaryClassLoaderContext.of(pluginClassLoader)) {</span>
<span class="nc" id="L119">                return delegate.next();</span>
            }
        }
    }

    /**
     * Loads all classes from the plugin jar except for explicitly white-listed packages
     * (org.apache.flink, logging).
     *
     * &lt;p&gt;No class/resource in the system class loader (everything in lib/) can be seen in the
     * plugin except those starting with a whitelist prefix.
     */
    private static final class PluginClassLoader extends URLClassLoader {
        private static final ClassLoader PLATFORM_OR_BOOTSTRAP_LOADER;

        private final ClassLoader flinkClassLoader;

        private final String[] allowedFlinkPackages;

        private final String[] allowedResourcePrefixes;

        PluginClassLoader(
                URL[] pluginResourceURLs,
                ClassLoader flinkClassLoader,
                String[] allowedFlinkPackages) {
<span class="nc" id="L144">            super(pluginResourceURLs, PLATFORM_OR_BOOTSTRAP_LOADER);</span>
<span class="nc" id="L145">            this.flinkClassLoader = flinkClassLoader;</span>
<span class="nc" id="L146">            this.allowedFlinkPackages = allowedFlinkPackages;</span>
<span class="nc" id="L147">            allowedResourcePrefixes =</span>
<span class="nc" id="L148">                    Arrays.stream(allowedFlinkPackages)</span>
<span class="nc" id="L149">                            .map(packageName -&gt; packageName.replace('.', '/'))</span>
<span class="nc" id="L150">                            .toArray(String[]::new);</span>
<span class="nc" id="L151">        }</span>

        @Override
        protected Class&lt;?&gt; loadClass(final String name, final boolean resolve)
                throws ClassNotFoundException {
<span class="nc" id="L156">            synchronized (getClassLoadingLock(name)) {</span>
<span class="nc" id="L157">                final Class&lt;?&gt; loadedClass = findLoadedClass(name);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">                if (loadedClass != null) {</span>
<span class="nc" id="L159">                    return resolveIfNeeded(resolve, loadedClass);</span>
                }

<span class="nc bnc" id="L162" title="All 2 branches missed.">                if (isAllowedFlinkClass(name)) {</span>
                    try {
<span class="nc" id="L164">                        return resolveIfNeeded(resolve, flinkClassLoader.loadClass(name));</span>
<span class="nc" id="L165">                    } catch (ClassNotFoundException e) {</span>
                        // fallback to resolving it in this classloader
                        // for cases where the plugin uses org.apache.flink namespace
                    }
                }

<span class="nc" id="L171">                return super.loadClass(name, resolve);</span>
            }
        }

        private Class&lt;?&gt; resolveIfNeeded(final boolean resolve, final Class&lt;?&gt; loadedClass) {
<span class="nc bnc" id="L176" title="All 2 branches missed.">            if (resolve) {</span>
<span class="nc" id="L177">                resolveClass(loadedClass);</span>
            }

<span class="nc" id="L180">            return loadedClass;</span>
        }

        @Override
        public URL getResource(final String name) {
<span class="nc bnc" id="L185" title="All 2 branches missed.">            if (isAllowedFlinkResource(name)) {</span>
<span class="nc" id="L186">                return flinkClassLoader.getResource(name);</span>
            }

<span class="nc" id="L189">            return super.getResource(name);</span>
        }

        @Override
        public Enumeration&lt;URL&gt; getResources(final String name) throws IOException {
            // ChildFirstClassLoader merges child and parent resources
<span class="nc bnc" id="L195" title="All 2 branches missed.">            if (isAllowedFlinkResource(name)) {</span>
<span class="nc" id="L196">                return flinkClassLoader.getResources(name);</span>
            }

<span class="nc" id="L199">            return super.getResources(name);</span>
        }

        private boolean isAllowedFlinkClass(final String name) {
<span class="nc" id="L203">            return Arrays.stream(allowedFlinkPackages).anyMatch(name::startsWith);</span>
        }

        private boolean isAllowedFlinkResource(final String name) {
<span class="nc" id="L207">            return Arrays.stream(allowedResourcePrefixes).anyMatch(name::startsWith);</span>
        }

        static {
<span class="nc" id="L211">            ClassLoader platformLoader = null;</span>
            try {
<span class="nc" id="L213">                platformLoader =</span>
                        (ClassLoader)
<span class="nc" id="L215">                                ClassLoader.class.getMethod(&quot;getPlatformClassLoader&quot;).invoke(null);</span>
<span class="nc" id="L216">            } catch (NoSuchMethodException e) {</span>
                // on Java 8 this method does not exist, but using null indicates the bootstrap
                // loader that we want
                // to have
<span class="nc" id="L220">            } catch (Exception e) {</span>
<span class="nc" id="L221">                throw new IllegalStateException(</span>
                        &quot;Cannot retrieve platform classloader on Java 9+&quot;, e);
<span class="nc" id="L223">            }</span>
<span class="nc" id="L224">            PLATFORM_OR_BOOTSTRAP_LOADER = platformLoader;</span>

<span class="nc" id="L226">            ClassLoader.registerAsParallelCapable();</span>
<span class="nc" id="L227">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>