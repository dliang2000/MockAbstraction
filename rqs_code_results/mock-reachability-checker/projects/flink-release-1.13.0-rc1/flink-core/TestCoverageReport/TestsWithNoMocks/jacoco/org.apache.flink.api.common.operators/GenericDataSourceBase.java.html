<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GenericDataSourceBase.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Flink : Core</a> &gt; <a href="index.source.html" class="el_package">org.apache.flink.api.common.operators</a> &gt; <span class="el_source">GenericDataSourceBase.java</span></div><h1>GenericDataSourceBase.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.flink.api.common.operators;

import org.apache.flink.annotation.Internal;
import org.apache.flink.api.common.ExecutionConfig;
import org.apache.flink.api.common.functions.Partitioner;
import org.apache.flink.api.common.functions.RuntimeContext;
import org.apache.flink.api.common.io.InputFormat;
import org.apache.flink.api.common.io.RichInputFormat;
import org.apache.flink.api.common.operators.util.UserCodeClassWrapper;
import org.apache.flink.api.common.operators.util.UserCodeObjectWrapper;
import org.apache.flink.api.common.operators.util.UserCodeWrapper;
import org.apache.flink.api.common.typeutils.TypeSerializer;
import org.apache.flink.core.io.InputSplit;
import org.apache.flink.util.Visitor;

import java.util.ArrayList;
import java.util.List;

/**
 * Abstract superclass for data sources in a Pact plan.
 *
 * @param &lt;OUT&gt; The output type of the data source
 * @param &lt;T&gt; The type of input format invoked by instances of this data source.
 */
@Internal
public class GenericDataSourceBase&lt;OUT, T extends InputFormat&lt;OUT, ?&gt;&gt; extends Operator&lt;OUT&gt; {

    private static final String DEFAULT_NAME = &quot;&lt;Unnamed Generic Data Source&gt;&quot;;

    protected final UserCodeWrapper&lt;? extends T&gt; formatWrapper;

    protected String statisticsKey;

    private SplitDataProperties splitProperties;

    /**
     * Creates a new instance for the given file using the given input format.
     *
     * @param format The {@link org.apache.flink.api.common.io.InputFormat} implementation used to
     *     read the data.
     * @param operatorInfo The type information for the operator.
     * @param name The given name for the Pact, used in plans, logs and progress messages.
     */
    public GenericDataSourceBase(T format, OperatorInformation&lt;OUT&gt; operatorInfo, String name) {
<span class="fc" id="L63">        super(operatorInfo, name);</span>

<span class="pc bpc" id="L65" title="1 of 2 branches missed.">        if (format == null) {</span>
<span class="nc" id="L66">            throw new IllegalArgumentException(&quot;Input format may not be null.&quot;);</span>
        }

<span class="fc" id="L69">        this.formatWrapper = new UserCodeObjectWrapper&lt;T&gt;(format);</span>
<span class="fc" id="L70">    }</span>

    /**
     * Creates a new instance for the given file using the given input format, using the default
     * name.
     *
     * @param format The {@link org.apache.flink.api.common.io.InputFormat} implementation used to
     *     read the data.
     * @param operatorInfo The type information for the operator.
     */
    public GenericDataSourceBase(T format, OperatorInformation&lt;OUT&gt; operatorInfo) {
<span class="nc" id="L81">        super(operatorInfo, DEFAULT_NAME);</span>

<span class="nc bnc" id="L83" title="All 2 branches missed.">        if (format == null) {</span>
<span class="nc" id="L84">            throw new IllegalArgumentException(&quot;Input format may not be null.&quot;);</span>
        }

<span class="nc" id="L87">        this.formatWrapper = new UserCodeObjectWrapper&lt;T&gt;(format);</span>
<span class="nc" id="L88">    }</span>

    /**
     * Creates a new instance for the given file using the given input format.
     *
     * @param format The {@link org.apache.flink.api.common.io.InputFormat} implementation used to
     *     read the data.
     * @param operatorInfo The type information for the operator.
     * @param name The given name for the Pact, used in plans, logs and progress messages.
     */
    public GenericDataSourceBase(
            Class&lt;? extends T&gt; format, OperatorInformation&lt;OUT&gt; operatorInfo, String name) {
<span class="nc" id="L100">        super(operatorInfo, name);</span>

<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (format == null) {</span>
<span class="nc" id="L103">            throw new IllegalArgumentException(&quot;Input format may not be null.&quot;);</span>
        }

<span class="nc" id="L106">        this.formatWrapper = new UserCodeClassWrapper&lt;T&gt;(format);</span>
<span class="nc" id="L107">    }</span>

    /**
     * Creates a new instance for the given file using the given input format, using the default
     * name.
     *
     * @param format The {@link org.apache.flink.api.common.io.InputFormat} implementation used to
     *     read the data.
     * @param operatorInfo The type information for the operator.
     */
    public GenericDataSourceBase(Class&lt;? extends T&gt; format, OperatorInformation&lt;OUT&gt; operatorInfo) {
<span class="nc" id="L118">        super(operatorInfo, DEFAULT_NAME);</span>

<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (format == null) {</span>
<span class="nc" id="L121">            throw new IllegalArgumentException(&quot;Input format may not be null.&quot;);</span>
        }

<span class="nc" id="L124">        this.formatWrapper = new UserCodeClassWrapper&lt;T&gt;(format);</span>
<span class="nc" id="L125">    }</span>

    // --------------------------------------------------------------------------------------------

    /**
     * Gets the class describing the input format.
     *
     * @return The class describing the input format.
     */
    public UserCodeWrapper&lt;? extends T&gt; getFormatWrapper() {
<span class="nc" id="L135">        return this.formatWrapper;</span>
    }

    /**
     * Gets the class describing the input format.
     *
     * &lt;p&gt;This method is basically identical to {@link #getFormatWrapper()}.
     *
     * @return The class describing the input format.
     * @see org.apache.flink.api.common.operators.Operator#getUserCodeWrapper()
     */
    @Override
    public UserCodeWrapper&lt;? extends T&gt; getUserCodeWrapper() {
<span class="nc" id="L148">        return this.formatWrapper;</span>
    }

    // --------------------------------------------------------------------------------------------

    /**
     * Gets the key under which statistics about this data source may be obtained from the
     * statistics cache.
     *
     * @return The statistics cache key.
     */
    public String getStatisticsKey() {
<span class="nc" id="L160">        return this.statisticsKey;</span>
    }

    /**
     * Sets the key under which statistics about this data source may be obtained from the
     * statistics cache. Useful for testing purposes, when providing mock statistics.
     *
     * @param statisticsKey The key for the statistics object.
     */
    public void setStatisticsKey(String statisticsKey) {
<span class="nc" id="L170">        this.statisticsKey = statisticsKey;</span>
<span class="nc" id="L171">    }</span>

    /**
     * Sets properties of input splits for this data source. Split properties can help to generate
     * more efficient execution plans. &lt;br&gt;
     * &lt;b&gt; IMPORTANT: Providing wrong split data properties can cause wrong results! &lt;/b&gt;
     *
     * @param splitDataProperties The data properties of this data source's splits.
     */
    public void setSplitDataProperties(SplitDataProperties&lt;OUT&gt; splitDataProperties) {
<span class="nc" id="L181">        this.splitProperties = splitDataProperties;</span>
<span class="nc" id="L182">    }</span>

    /**
     * Returns the data properties of this data source's splits.
     *
     * @return The data properties of this data source's splits or null if no properties have been
     *     set.
     */
    public SplitDataProperties&lt;OUT&gt; getSplitDataProperties() {
<span class="nc" id="L191">        return this.splitProperties;</span>
    }

    // --------------------------------------------------------------------------------------------

    /**
     * Accepts the visitor and applies it this instance. Since the data sources have no inputs, no
     * recursive descend happens. The visitors pre-visit method is called and, if returning
     * &lt;tt&gt;true&lt;/tt&gt;, the post-visit method is called.
     *
     * @param visitor The visitor.
     * @see org.apache.flink.util.Visitable#accept(org.apache.flink.util.Visitor)
     */
    @Override
    public void accept(Visitor&lt;Operator&lt;?&gt;&gt; visitor) {
<span class="nc bnc" id="L206" title="All 2 branches missed.">        if (visitor.preVisit(this)) {</span>
<span class="nc" id="L207">            visitor.postVisit(this);</span>
        }
<span class="nc" id="L209">    }</span>

    // --------------------------------------------------------------------------------------------

    protected List&lt;OUT&gt; executeOnCollections(RuntimeContext ctx, ExecutionConfig executionConfig)
            throws Exception {
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L216">        InputFormat&lt;OUT, InputSplit&gt; inputFormat =</span>
<span class="fc" id="L217">                (InputFormat&lt;OUT, InputSplit&gt;) this.formatWrapper.getUserCodeObject();</span>
        // configure the input format
<span class="fc" id="L219">        inputFormat.configure(this.parameters);</span>

        // open the input format
<span class="fc bfc" id="L222" title="All 2 branches covered.">        if (inputFormat instanceof RichInputFormat) {</span>
<span class="fc" id="L223">            ((RichInputFormat) inputFormat).setRuntimeContext(ctx);</span>
<span class="fc" id="L224">            ((RichInputFormat) inputFormat).openInputFormat();</span>
        }

<span class="fc" id="L227">        List&lt;OUT&gt; result = new ArrayList&lt;OUT&gt;();</span>

        // splits
<span class="fc" id="L230">        InputSplit[] splits = inputFormat.createInputSplits(1);</span>
<span class="fc" id="L231">        TypeSerializer&lt;OUT&gt; serializer =</span>
<span class="fc" id="L232">                getOperatorInfo().getOutputType().createSerializer(executionConfig);</span>

<span class="fc bfc" id="L234" title="All 2 branches covered.">        for (InputSplit split : splits) {</span>
<span class="fc" id="L235">            inputFormat.open(split);</span>

<span class="fc bfc" id="L237" title="All 2 branches covered.">            while (!inputFormat.reachedEnd()) {</span>
<span class="fc" id="L238">                OUT next = inputFormat.nextRecord(serializer.createInstance());</span>
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">                if (next != null) {</span>
<span class="fc" id="L240">                    result.add(serializer.copy(next));</span>
                }
<span class="fc" id="L242">            }</span>

<span class="fc" id="L244">            inputFormat.close();</span>
        }

        // close the input format
<span class="fc bfc" id="L248" title="All 2 branches covered.">        if (inputFormat instanceof RichInputFormat) {</span>
<span class="fc" id="L249">            ((RichInputFormat) inputFormat).closeInputFormat();</span>
        }

<span class="fc" id="L252">        return result;</span>
    }

    // --------------------------------------------------------------------------------------------

    public String toString() {
<span class="nc" id="L258">        return this.name;</span>
    }

    public static interface SplitDataProperties&lt;T&gt; {

        public int[] getSplitPartitionKeys();

        public Partitioner&lt;T&gt; getSplitPartitioner();

        public int[] getSplitGroupKeys();

        public Ordering getSplitOrder();
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>