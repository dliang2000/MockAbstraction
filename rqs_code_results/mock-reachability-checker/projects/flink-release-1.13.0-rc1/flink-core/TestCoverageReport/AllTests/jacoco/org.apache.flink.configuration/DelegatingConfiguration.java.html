<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DelegatingConfiguration.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Flink : Core</a> &gt; <a href="index.source.html" class="el_package">org.apache.flink.configuration</a> &gt; <span class="el_source">DelegatingConfiguration.java</span></div><h1>DelegatingConfiguration.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.flink.configuration;

import org.apache.flink.core.memory.DataInputView;
import org.apache.flink.core.memory.DataOutputView;
import org.apache.flink.util.Preconditions;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Properties;
import java.util.Set;

import static org.apache.flink.configuration.FallbackKey.createDeprecatedKey;

/**
 * A configuration that manages a subset of keys with a common prefix from a given configuration.
 */
public final class DelegatingConfiguration extends Configuration {

    private static final long serialVersionUID = 1L;

    private final Configuration backingConfig; // the configuration actually storing the data

    private String prefix; // the prefix key by which keys for this config are marked

    // --------------------------------------------------------------------------------------------

    /** Default constructor for serialization. Creates an empty delegating configuration. */
<span class="nc" id="L52">    public DelegatingConfiguration() {</span>
<span class="nc" id="L53">        this.backingConfig = new Configuration();</span>
<span class="nc" id="L54">        this.prefix = &quot;&quot;;</span>
<span class="nc" id="L55">    }</span>

    /**
     * Creates a new delegating configuration which stores its key/value pairs in the given
     * configuration using the specifies key prefix.
     *
     * @param backingConfig The configuration holding the actual config data.
     * @param prefix The prefix prepended to all config keys.
     */
<span class="fc" id="L64">    public DelegatingConfiguration(Configuration backingConfig, String prefix) {</span>
<span class="fc" id="L65">        this.backingConfig = Preconditions.checkNotNull(backingConfig);</span>
<span class="fc" id="L66">        this.prefix = prefix;</span>
<span class="fc" id="L67">    }</span>

    // --------------------------------------------------------------------------------------------

    @Override
    public String getString(String key, String defaultValue) {
<span class="nc" id="L73">        return this.backingConfig.getString(this.prefix + key, defaultValue);</span>
    }

    @Override
    public String getString(ConfigOption&lt;String&gt; configOption) {
<span class="nc" id="L78">        return this.backingConfig.getString(prefixOption(configOption, prefix));</span>
    }

    @Override
    public String getString(ConfigOption&lt;String&gt; configOption, String overrideDefault) {
<span class="nc" id="L83">        return this.backingConfig.getString(prefixOption(configOption, prefix), overrideDefault);</span>
    }

    @Override
    public void setString(String key, String value) {
<span class="nc" id="L88">        this.backingConfig.setString(this.prefix + key, value);</span>
<span class="nc" id="L89">    }</span>

    @Override
    public void setString(ConfigOption&lt;String&gt; key, String value) {
<span class="nc" id="L93">        this.backingConfig.setString(prefix + key.key(), value);</span>
<span class="nc" id="L94">    }</span>

    @Override
    public &lt;T&gt; Class&lt;T&gt; getClass(
            String key, Class&lt;? extends T&gt; defaultValue, ClassLoader classLoader)
            throws ClassNotFoundException {
<span class="nc" id="L100">        return this.backingConfig.getClass(this.prefix + key, defaultValue, classLoader);</span>
    }

    @Override
    public void setClass(String key, Class&lt;?&gt; klazz) {
<span class="nc" id="L105">        this.backingConfig.setClass(this.prefix + key, klazz);</span>
<span class="nc" id="L106">    }</span>

    @Override
    public int getInteger(String key, int defaultValue) {
<span class="nc" id="L110">        return this.backingConfig.getInteger(this.prefix + key, defaultValue);</span>
    }

    @Override
    public int getInteger(ConfigOption&lt;Integer&gt; configOption) {
<span class="nc" id="L115">        return this.backingConfig.getInteger(prefixOption(configOption, prefix));</span>
    }

    @Override
    public int getInteger(ConfigOption&lt;Integer&gt; configOption, int overrideDefault) {
<span class="nc" id="L120">        return this.backingConfig.getInteger(configOption, overrideDefault);</span>
    }

    @Override
    public void setInteger(String key, int value) {
<span class="nc" id="L125">        this.backingConfig.setInteger(this.prefix + key, value);</span>
<span class="nc" id="L126">    }</span>

    @Override
    public void setInteger(ConfigOption&lt;Integer&gt; key, int value) {
<span class="nc" id="L130">        this.backingConfig.setInteger(prefix + key.key(), value);</span>
<span class="nc" id="L131">    }</span>

    @Override
    public long getLong(String key, long defaultValue) {
<span class="nc" id="L135">        return this.backingConfig.getLong(this.prefix + key, defaultValue);</span>
    }

    @Override
    public long getLong(ConfigOption&lt;Long&gt; configOption) {
<span class="nc" id="L140">        return this.backingConfig.getLong(prefixOption(configOption, prefix));</span>
    }

    @Override
    public long getLong(ConfigOption&lt;Long&gt; configOption, long overrideDefault) {
<span class="nc" id="L145">        return this.backingConfig.getLong(configOption, overrideDefault);</span>
    }

    @Override
    public void setLong(String key, long value) {
<span class="nc" id="L150">        this.backingConfig.setLong(this.prefix + key, value);</span>
<span class="nc" id="L151">    }</span>

    @Override
    public void setLong(ConfigOption&lt;Long&gt; key, long value) {
<span class="nc" id="L155">        this.backingConfig.setLong(prefix + key.key(), value);</span>
<span class="nc" id="L156">    }</span>

    @Override
    public boolean getBoolean(String key, boolean defaultValue) {
<span class="nc" id="L160">        return this.backingConfig.getBoolean(this.prefix + key, defaultValue);</span>
    }

    @Override
    public boolean getBoolean(ConfigOption&lt;Boolean&gt; configOption) {
<span class="nc" id="L165">        return this.backingConfig.getBoolean(prefixOption(configOption, prefix));</span>
    }

    @Override
    public void setBoolean(String key, boolean value) {
<span class="nc" id="L170">        this.backingConfig.setBoolean(this.prefix + key, value);</span>
<span class="nc" id="L171">    }</span>

    @Override
    public void setBoolean(ConfigOption&lt;Boolean&gt; key, boolean value) {
<span class="nc" id="L175">        this.backingConfig.setBoolean(prefix + key.key(), value);</span>
<span class="nc" id="L176">    }</span>

    @Override
    public boolean getBoolean(ConfigOption&lt;Boolean&gt; configOption, boolean overrideDefault) {
<span class="nc" id="L180">        return this.backingConfig.getBoolean(configOption, overrideDefault);</span>
    }

    @Override
    public float getFloat(String key, float defaultValue) {
<span class="nc" id="L185">        return this.backingConfig.getFloat(this.prefix + key, defaultValue);</span>
    }

    @Override
    public float getFloat(ConfigOption&lt;Float&gt; configOption) {
<span class="nc" id="L190">        return this.backingConfig.getFloat(prefixOption(configOption, prefix));</span>
    }

    @Override
    public float getFloat(ConfigOption&lt;Float&gt; configOption, float overrideDefault) {
<span class="nc" id="L195">        return this.backingConfig.getFloat(configOption, overrideDefault);</span>
    }

    @Override
    public void setFloat(String key, float value) {
<span class="nc" id="L200">        this.backingConfig.setFloat(this.prefix + key, value);</span>
<span class="nc" id="L201">    }</span>

    @Override
    public void setFloat(ConfigOption&lt;Float&gt; key, float value) {
<span class="nc" id="L205">        this.backingConfig.setFloat(prefix + key.key(), value);</span>
<span class="nc" id="L206">    }</span>

    @Override
    public double getDouble(String key, double defaultValue) {
<span class="nc" id="L210">        return this.backingConfig.getDouble(this.prefix + key, defaultValue);</span>
    }

    @Override
    public double getDouble(ConfigOption&lt;Double&gt; configOption) {
<span class="nc" id="L215">        return this.backingConfig.getDouble(prefixOption(configOption, prefix));</span>
    }

    @Override
    public double getDouble(ConfigOption&lt;Double&gt; configOption, double overrideDefault) {
<span class="nc" id="L220">        return this.backingConfig.getDouble(configOption, overrideDefault);</span>
    }

    @Override
    public void setDouble(String key, double value) {
<span class="nc" id="L225">        this.backingConfig.setDouble(this.prefix + key, value);</span>
<span class="nc" id="L226">    }</span>

    @Override
    public void setDouble(ConfigOption&lt;Double&gt; key, double value) {
<span class="nc" id="L230">        this.backingConfig.setDouble(prefix + key.key(), value);</span>
<span class="nc" id="L231">    }</span>

    @Override
    public byte[] getBytes(final String key, final byte[] defaultValue) {
<span class="nc" id="L235">        return this.backingConfig.getBytes(this.prefix + key, defaultValue);</span>
    }

    @Override
    public void setBytes(final String key, final byte[] bytes) {
<span class="nc" id="L240">        this.backingConfig.setBytes(this.prefix + key, bytes);</span>
<span class="nc" id="L241">    }</span>

    @Override
    public String getValue(ConfigOption&lt;?&gt; configOption) {
<span class="nc" id="L245">        return this.backingConfig.getValue(prefixOption(configOption, prefix));</span>
    }

    @Override
    public &lt;T extends Enum&lt;T&gt;&gt; T getEnum(
            final Class&lt;T&gt; enumClass, final ConfigOption&lt;String&gt; configOption) {
<span class="nc" id="L251">        return this.backingConfig.getEnum(enumClass, prefixOption(configOption, prefix));</span>
    }

    @Override
    public void addAllToProperties(Properties props) {
        // only add keys with our prefix
<span class="fc" id="L257">        synchronized (backingConfig.confData) {</span>
<span class="fc bfc" id="L258" title="All 2 branches covered.">            for (Map.Entry&lt;String, Object&gt; entry : backingConfig.confData.entrySet()) {</span>
<span class="fc bfc" id="L259" title="All 2 branches covered.">                if (entry.getKey().startsWith(prefix)) {</span>
<span class="fc" id="L260">                    String keyWithoutPrefix =</span>
<span class="fc" id="L261">                            entry.getKey().substring(prefix.length(), entry.getKey().length());</span>

<span class="fc" id="L263">                    props.put(keyWithoutPrefix, entry.getValue());</span>
                } else {
                    // don't add stuff that doesn't have our prefix
                }
<span class="fc" id="L267">            }</span>
<span class="fc" id="L268">        }</span>
<span class="fc" id="L269">    }</span>

    @Override
    public void addAll(Configuration other) {
<span class="nc" id="L273">        this.addAll(other, &quot;&quot;);</span>
<span class="nc" id="L274">    }</span>

    @Override
    public void addAll(Configuration other, String prefix) {
<span class="nc" id="L278">        this.backingConfig.addAll(other, this.prefix + prefix);</span>
<span class="nc" id="L279">    }</span>

    @Override
    public String toString() {
<span class="nc" id="L283">        return backingConfig.toString();</span>
    }

    @Override
    public Set&lt;String&gt; keySet() {
<span class="fc bfc" id="L288" title="All 2 branches covered.">        if (this.prefix == null) {</span>
<span class="fc" id="L289">            return this.backingConfig.keySet();</span>
        }

<span class="fc" id="L292">        final HashSet&lt;String&gt; set = new HashSet&lt;&gt;();</span>
<span class="fc" id="L293">        int prefixLen = this.prefix.length();</span>

<span class="fc bfc" id="L295" title="All 2 branches covered.">        for (String key : this.backingConfig.keySet()) {</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">            if (key.startsWith(prefix)) {</span>
<span class="fc" id="L297">                set.add(key.substring(prefixLen));</span>
            }
<span class="fc" id="L299">        }</span>

<span class="fc" id="L301">        return set;</span>
    }

    @Override
    public Configuration clone() {
<span class="nc" id="L306">        return new DelegatingConfiguration(backingConfig.clone(), prefix);</span>
    }

    @Override
    public Map&lt;String, String&gt; toMap() {
<span class="fc" id="L311">        Map&lt;String, String&gt; map = backingConfig.toMap();</span>
<span class="fc" id="L312">        Map&lt;String, String&gt; prefixed = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L313" title="All 2 branches covered.">        for (Map.Entry&lt;String, String&gt; entry : map.entrySet()) {</span>
<span class="fc bfc" id="L314" title="All 2 branches covered.">            if (entry.getKey().startsWith(prefix)) {</span>
<span class="fc" id="L315">                String keyWithoutPrefix = entry.getKey().substring(prefix.length());</span>
<span class="fc" id="L316">                prefixed.put(keyWithoutPrefix, entry.getValue());</span>
            }
<span class="fc" id="L318">        }</span>
<span class="fc" id="L319">        return prefixed;</span>
    }

    @Override
    public &lt;T&gt; boolean removeConfig(ConfigOption&lt;T&gt; configOption) {
<span class="nc" id="L324">        return backingConfig.removeConfig(configOption);</span>
    }

    @Override
    public boolean containsKey(String key) {
<span class="nc" id="L329">        return backingConfig.containsKey(prefix + key);</span>
    }

    @Override
    public boolean contains(ConfigOption&lt;?&gt; configOption) {
<span class="nc" id="L334">        return backingConfig.contains(prefixOption(configOption, prefix));</span>
    }

    @Override
    public &lt;T&gt; T get(ConfigOption&lt;T&gt; option) {
<span class="nc" id="L339">        return backingConfig.get(prefixOption(option, prefix));</span>
    }

    @Override
    public &lt;T&gt; Optional&lt;T&gt; getOptional(ConfigOption&lt;T&gt; option) {
<span class="nc" id="L344">        return backingConfig.getOptional(prefixOption(option, prefix));</span>
    }

    @Override
    public &lt;T&gt; Configuration set(ConfigOption&lt;T&gt; option, T value) {
<span class="nc" id="L349">        return backingConfig.set(prefixOption(option, prefix), value);</span>
    }

    // --------------------------------------------------------------------------------------------

    @Override
    public void read(DataInputView in) throws IOException {
<span class="nc" id="L356">        this.prefix = in.readUTF();</span>
<span class="nc" id="L357">        this.backingConfig.read(in);</span>
<span class="nc" id="L358">    }</span>

    @Override
    public void write(DataOutputView out) throws IOException {
<span class="nc" id="L362">        out.writeUTF(this.prefix);</span>
<span class="nc" id="L363">        this.backingConfig.write(out);</span>
<span class="nc" id="L364">    }</span>

    // --------------------------------------------------------------------------------------------

    @Override
    public int hashCode() {
<span class="nc" id="L370">        return this.prefix.hashCode() ^ this.backingConfig.hashCode();</span>
    }

    @Override
    public boolean equals(Object obj) {
<span class="nc bnc" id="L375" title="All 2 branches missed.">        if (obj instanceof DelegatingConfiguration) {</span>
<span class="nc" id="L376">            DelegatingConfiguration other = (DelegatingConfiguration) obj;</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">            return this.prefix.equals(other.prefix)</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">                    &amp;&amp; this.backingConfig.equals(other.backingConfig);</span>
        } else {
<span class="nc" id="L380">            return false;</span>
        }
    }

    // --------------------------------------------------------------------------------------------

    private static &lt;T&gt; ConfigOption&lt;T&gt; prefixOption(ConfigOption&lt;T&gt; option, String prefix) {
<span class="nc" id="L387">        String key = prefix + option.key();</span>

        List&lt;FallbackKey&gt; deprecatedKeys;
<span class="nc bnc" id="L390" title="All 2 branches missed.">        if (option.hasFallbackKeys()) {</span>
<span class="nc" id="L391">            deprecatedKeys = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">            for (FallbackKey dk : option.fallbackKeys()) {</span>
<span class="nc" id="L393">                deprecatedKeys.add(createDeprecatedKey(prefix + dk.getKey()));</span>
<span class="nc" id="L394">            }</span>
        } else {
<span class="nc" id="L396">            deprecatedKeys = Collections.emptyList();</span>
        }

<span class="nc" id="L399">        FallbackKey[] deprecated = deprecatedKeys.toArray(new FallbackKey[0]);</span>
<span class="nc" id="L400">        return new ConfigOption&lt;T&gt;(</span>
                key,
<span class="nc" id="L402">                option.getClazz(),</span>
<span class="nc" id="L403">                option.description(),</span>
<span class="nc" id="L404">                option.defaultValue(),</span>
<span class="nc" id="L405">                option.isList(),</span>
                deprecated);
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>