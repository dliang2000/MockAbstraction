<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TypeSerializerSnapshotSerializationUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Flink : Core</a> &gt; <a href="index.source.html" class="el_package">org.apache.flink.api.common.typeutils</a> &gt; <span class="el_source">TypeSerializerSnapshotSerializationUtil.java</span></div><h1>TypeSerializerSnapshotSerializationUtil.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.flink.api.common.typeutils;

import org.apache.flink.annotation.VisibleForTesting;
import org.apache.flink.core.io.VersionedIOReadableWritable;
import org.apache.flink.core.memory.DataInputView;
import org.apache.flink.core.memory.DataOutputView;
import org.apache.flink.util.InstantiationUtil;
import org.apache.flink.util.Preconditions;

import javax.annotation.Nullable;

import java.io.IOException;

import static org.apache.flink.util.Preconditions.checkState;

/** Utility methods for serialization of {@link TypeSerializerSnapshot}. */
<span class="nc" id="L35">public class TypeSerializerSnapshotSerializationUtil {</span>

    /**
     * Writes a {@link TypeSerializerSnapshot} to the provided data output view.
     *
     * &lt;p&gt;It is written with a format that can be later read again using {@link
     * #readSerializerSnapshot(DataInputView, ClassLoader, TypeSerializer)}.
     *
     * @param out the data output view
     * @param serializerSnapshot the serializer configuration snapshot to write
     * @param serializer the prior serializer. This needs to be written of the serializer snapshot
     *     if the serializer snapshot is still the legacy {@link TypeSerializerConfigSnapshot}.
     */
    public static &lt;T&gt; void writeSerializerSnapshot(
            DataOutputView out,
            TypeSerializerSnapshot&lt;T&gt; serializerSnapshot,
            TypeSerializer&lt;T&gt; serializer)
            throws IOException {

<span class="fc" id="L54">        new TypeSerializerSnapshotSerializationProxy&lt;&gt;(serializerSnapshot, serializer).write(out);</span>
<span class="fc" id="L55">    }</span>

    /**
     * Reads from a data input view a {@link TypeSerializerSnapshot} that was previously written
     * using {@link TypeSerializerSnapshotSerializationUtil#writeSerializerSnapshot(DataOutputView,
     * TypeSerializerSnapshot, TypeSerializer)}.
     *
     * @param in the data input view
     * @param userCodeClassLoader the user code class loader to use
     * @param existingPriorSerializer the prior serializer. This would only be non-null if we are
     *     restoring from a snapshot taken with Flink version &lt;= 1.6.
     * @return the read serializer configuration snapshot
     */
    public static &lt;T&gt; TypeSerializerSnapshot&lt;T&gt; readSerializerSnapshot(
            DataInputView in,
            ClassLoader userCodeClassLoader,
            @Nullable TypeSerializer&lt;T&gt; existingPriorSerializer)
            throws IOException {

<span class="fc" id="L74">        final TypeSerializerSnapshotSerializationProxy&lt;T&gt; proxy =</span>
                new TypeSerializerSnapshotSerializationProxy&lt;&gt;(
                        userCodeClassLoader, existingPriorSerializer);
<span class="fc" id="L77">        proxy.read(in);</span>

<span class="fc" id="L79">        return proxy.getSerializerSnapshot();</span>
    }

    public static &lt;T&gt; TypeSerializerSnapshot&lt;T&gt; readAndInstantiateSnapshotClass(
            DataInputView in, ClassLoader cl) throws IOException {
<span class="fc" id="L84">        Class&lt;TypeSerializerSnapshot&lt;T&gt;&gt; clazz =</span>
<span class="fc" id="L85">                InstantiationUtil.resolveClassByName(in, cl, TypeSerializerSnapshot.class);</span>

<span class="fc" id="L87">        return InstantiationUtil.instantiate(clazz);</span>
    }

    /** Utility serialization proxy for a {@link TypeSerializerSnapshot}. */
    static final class TypeSerializerSnapshotSerializationProxy&lt;T&gt;
            extends VersionedIOReadableWritable {

        private static final int VERSION = 2;

        private ClassLoader userCodeClassLoader;
        private TypeSerializerSnapshot&lt;T&gt; serializerSnapshot;
        @Nullable private TypeSerializer&lt;T&gt; serializer;

        /** Constructor for reading serializers. */
        TypeSerializerSnapshotSerializationProxy(
                ClassLoader userCodeClassLoader,
<span class="fc" id="L103">                @Nullable TypeSerializer&lt;T&gt; existingPriorSerializer) {</span>
<span class="fc" id="L104">            this.userCodeClassLoader = Preconditions.checkNotNull(userCodeClassLoader);</span>
<span class="fc" id="L105">            this.serializer = existingPriorSerializer;</span>
<span class="fc" id="L106">        }</span>

        /** Constructor for writing out serializers. */
        TypeSerializerSnapshotSerializationProxy(
<span class="fc" id="L110">                TypeSerializerSnapshot&lt;T&gt; serializerConfigSnapshot, TypeSerializer&lt;T&gt; serializer) {</span>
<span class="fc" id="L111">            this.serializerSnapshot = Preconditions.checkNotNull(serializerConfigSnapshot);</span>
<span class="fc" id="L112">            this.serializer = Preconditions.checkNotNull(serializer);</span>
<span class="fc" id="L113">        }</span>

        /**
         * Binary format layout of a written serializer snapshot is as follows:
         *
         * &lt;ul&gt;
         *   &lt;li&gt;1. Format version of this util.
         *   &lt;li&gt;2. Name of the TypeSerializerSnapshot class.
         *   &lt;li&gt;3. The version of the TypeSerializerSnapshot's binary format.
         *   &lt;li&gt;4. The actual serializer snapshot data.
         * &lt;/ul&gt;
         */
        @SuppressWarnings(&quot;deprecation&quot;)
        @Override
        public void write(DataOutputView out) throws IOException {
<span class="fc" id="L128">            setSerializerForWriteIfOldPath(serializerSnapshot, serializer);</span>

            // write the format version of this utils format
<span class="fc" id="L131">            super.write(out);</span>

<span class="fc" id="L133">            TypeSerializerSnapshot.writeVersionedSnapshot(out, serializerSnapshot);</span>
<span class="fc" id="L134">        }</span>

        @SuppressWarnings(&quot;unchecked&quot;)
        @Override
        public void read(DataInputView in) throws IOException {
            // read version
<span class="fc" id="L140">            super.read(in);</span>
<span class="fc" id="L141">            final int version = getReadVersion();</span>

<span class="pc bpc" id="L143" title="1 of 3 branches missed.">            switch (version) {</span>
                case 2:
<span class="fc" id="L145">                    serializerSnapshot = deserializeV2(in, userCodeClassLoader);</span>
<span class="fc" id="L146">                    break;</span>
                case 1:
<span class="fc" id="L148">                    serializerSnapshot = deserializeV1(in, userCodeClassLoader, serializer);</span>
<span class="fc" id="L149">                    break;</span>
                default:
<span class="nc" id="L151">                    throw new IOException(</span>
                            &quot;Unrecognized version for TypeSerializerSnapshot format: &quot; + version);
            }
<span class="fc" id="L154">        }</span>

        @Override
        public int getVersion() {
<span class="fc" id="L158">            return VERSION;</span>
        }

        @Override
        public int[] getCompatibleVersions() {
<span class="fc" id="L163">            return new int[] {VERSION, 1};</span>
        }

        TypeSerializerSnapshot&lt;T&gt; getSerializerSnapshot() {
<span class="fc" id="L167">            return serializerSnapshot;</span>
        }

        /** Deserialization path for Flink versions 1.7+. */
        @VisibleForTesting
        static &lt;T&gt; TypeSerializerSnapshot&lt;T&gt; deserializeV2(DataInputView in, ClassLoader cl)
                throws IOException {
<span class="fc" id="L174">            return TypeSerializerSnapshot.readVersionedSnapshot(in, cl);</span>
        }

        /** Deserialization path for Flink versions in [1.4, 1.6]. */
        @VisibleForTesting
        @SuppressWarnings(&quot;deprecation&quot;)
        static &lt;T&gt; TypeSerializerSnapshot&lt;T&gt; deserializeV1(
                DataInputView in, ClassLoader cl, @Nullable TypeSerializer&lt;T&gt; serializer)
                throws IOException {

<span class="fc" id="L184">            TypeSerializerSnapshot&lt;T&gt; snapshot = readAndInstantiateSnapshotClass(in, cl);</span>

            // if the snapshot was created before Flink 1.7, we need to distinguish the following
            // cases:
            //   - old snapshot type that needs serializer from the outside
            //   - new snapshot type that understands the old format and can produce a restore
            // serializer from it
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">            if (snapshot instanceof TypeSerializerConfigSnapshot) {</span>
<span class="fc" id="L192">                TypeSerializerConfigSnapshot&lt;T&gt; oldTypeSnapshot =</span>
                        (TypeSerializerConfigSnapshot&lt;T&gt;) snapshot;
<span class="fc" id="L194">                oldTypeSnapshot.setPriorSerializer(serializer);</span>
<span class="fc" id="L195">                oldTypeSnapshot.setUserCodeClassLoader(cl);</span>
<span class="fc" id="L196">                oldTypeSnapshot.read(in);</span>
<span class="fc" id="L197">            } else {</span>
                // new type, simple case
<span class="nc" id="L199">                int readVersion = in.readInt();</span>
<span class="nc" id="L200">                snapshot.readSnapshot(readVersion, in, cl);</span>
            }

<span class="fc" id="L203">            return snapshot;</span>
        }

        @SuppressWarnings(&quot;deprecation&quot;)
        private static &lt;T&gt; void setSerializerForWriteIfOldPath(
                TypeSerializerSnapshot&lt;T&gt; serializerSnapshot, TypeSerializer&lt;T&gt; serializer) {

            // for compatibility with non-upgraded serializers, put the serializer into the
            // config snapshot if it of the old version
<span class="fc bfc" id="L212" title="All 2 branches covered.">            if (serializerSnapshot instanceof TypeSerializerConfigSnapshot) {</span>
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">                checkState(serializer != null);</span>

<span class="fc" id="L215">                ((TypeSerializerConfigSnapshot&lt;T&gt;) serializerSnapshot)</span>
<span class="fc" id="L216">                        .setPriorSerializer(serializer);</span>
            }
<span class="fc" id="L218">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>