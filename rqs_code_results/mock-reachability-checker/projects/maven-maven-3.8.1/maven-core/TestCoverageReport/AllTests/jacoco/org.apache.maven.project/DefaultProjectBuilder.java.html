<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultProjectBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Maven Core</a> &gt; <a href="index.source.html" class="el_package">org.apache.maven.project</a> &gt; <span class="el_source">DefaultProjectBuilder.java</span></div><h1>DefaultProjectBuilder.java</h1><pre class="source lang-java linenums">package org.apache.maven.project;

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

import java.io.File;
import java.io.IOException;
import java.util.AbstractMap;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.apache.maven.RepositoryUtils;
import org.apache.maven.artifact.Artifact;
import org.apache.maven.artifact.InvalidArtifactRTException;
import org.apache.maven.artifact.InvalidRepositoryException;
import org.apache.maven.artifact.repository.ArtifactRepository;
import org.apache.maven.artifact.repository.LegacyLocalRepositoryManager;
import org.apache.maven.bridge.MavenRepositorySystem;
import org.apache.maven.model.Build;
import org.apache.maven.model.Dependency;
import org.apache.maven.model.DependencyManagement;
import org.apache.maven.model.DeploymentRepository;
import org.apache.maven.model.Extension;
import org.apache.maven.model.Model;
import org.apache.maven.model.Plugin;
import org.apache.maven.model.Profile;
import org.apache.maven.model.ReportPlugin;
import org.apache.maven.model.building.DefaultModelBuildingRequest;
import org.apache.maven.model.building.DefaultModelProblem;
import org.apache.maven.model.building.FileModelSource;
import org.apache.maven.model.building.ModelBuilder;
import org.apache.maven.model.building.ModelBuildingException;
import org.apache.maven.model.building.ModelBuildingRequest;
import org.apache.maven.model.building.ModelBuildingResult;
import org.apache.maven.model.building.ModelProblem;
import org.apache.maven.model.building.ModelProcessor;
import org.apache.maven.model.building.ModelSource;
import org.apache.maven.model.building.StringModelSource;
import org.apache.maven.model.resolution.ModelResolver;
import org.apache.maven.repository.internal.ArtifactDescriptorUtils;
import org.codehaus.plexus.component.annotations.Component;
import org.codehaus.plexus.component.annotations.Requirement;
import org.codehaus.plexus.logging.Logger;
import org.codehaus.plexus.util.Os;
import org.codehaus.plexus.util.StringUtils;
import org.eclipse.aether.RepositorySystemSession;
import org.eclipse.aether.RequestTrace;
import org.eclipse.aether.impl.RemoteRepositoryManager;
import org.eclipse.aether.repository.LocalRepositoryManager;
import org.eclipse.aether.repository.RemoteRepository;
import org.eclipse.aether.repository.WorkspaceRepository;
import org.eclipse.aether.resolution.ArtifactRequest;
import org.eclipse.aether.resolution.ArtifactResult;

/**
 * DefaultProjectBuilder
 */
@Component( role = ProjectBuilder.class )
<span class="fc" id="L83">public class DefaultProjectBuilder</span>
    implements ProjectBuilder
{

    public static final String DISABLE_GLOBAL_MODEL_CACHE_SYSTEM_PROPERTY =
            &quot;maven.defaultProjectBuilder.disableGlobalModelCache&quot;;

    @Requirement
    private Logger logger;

    @Requirement
    private ModelBuilder modelBuilder;

    @Requirement
    private ModelProcessor modelProcessor;

    @Requirement
    private ProjectBuildingHelper projectBuildingHelper;

    @Requirement
    private MavenRepositorySystem repositorySystem;

    @Requirement
    private org.eclipse.aether.RepositorySystem repoSystem;

    @Requirement
    private RemoteRepositoryManager repositoryManager;

    @Requirement
    private ProjectDependenciesResolver dependencyResolver;

<span class="fc" id="L114">    private final ReactorModelCache modelCache = new ReactorModelCache();</span>

    // ----------------------------------------------------------------------
    // MavenProjectBuilder Implementation
    // ----------------------------------------------------------------------

    @Override
    public ProjectBuildingResult build( File pomFile, ProjectBuildingRequest request )
        throws ProjectBuildingException
    {
<span class="fc" id="L124">        return build( pomFile, new FileModelSource( pomFile ),</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">                new InternalConfig( request, null, useGlobalModelCache() ? getModelCache() : null ) );</span>
    }

    private boolean useGlobalModelCache()
    {
<span class="fc bfc" id="L130" title="All 2 branches covered.">        return !Boolean.getBoolean( DISABLE_GLOBAL_MODEL_CACHE_SYSTEM_PROPERTY );</span>
    }

    @Override
    public ProjectBuildingResult build( ModelSource modelSource, ProjectBuildingRequest request )
        throws ProjectBuildingException
    {
<span class="fc" id="L137">        return build( null, modelSource,</span>
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">                 new InternalConfig( request, null, useGlobalModelCache() ? getModelCache() : null ) );</span>
    }

    private ProjectBuildingResult build( File pomFile, ModelSource modelSource, InternalConfig config )
        throws ProjectBuildingException
    {
<span class="fc" id="L144">        ClassLoader oldContextClassLoader = Thread.currentThread().getContextClassLoader();</span>

        try
        {
<span class="fc" id="L148">            ProjectBuildingRequest projectBuildingRequest = config.request;</span>

<span class="fc" id="L150">            MavenProject project = projectBuildingRequest.getProject();</span>

<span class="fc" id="L152">            List&lt;ModelProblem&gt; modelProblems = null;</span>
<span class="fc" id="L153">            Throwable error = null;</span>

<span class="pc bpc" id="L155" title="1 of 2 branches missed.">            if ( project == null )</span>
            {
<span class="fc" id="L157">                ModelBuildingRequest request = getModelBuildingRequest( config );</span>

<span class="fc" id="L159">                project = new MavenProject();</span>
<span class="fc" id="L160">                project.setFile( pomFile );</span>

<span class="fc" id="L162">                DefaultModelBuildingListener listener =</span>
                    new DefaultModelBuildingListener( project, projectBuildingHelper, projectBuildingRequest );
<span class="fc" id="L164">                request.setModelBuildingListener( listener );</span>

<span class="fc" id="L166">                request.setPomFile( pomFile );</span>
<span class="fc" id="L167">                request.setModelSource( modelSource );</span>
<span class="fc" id="L168">                request.setLocationTracking( true );</span>

                ModelBuildingResult result;
                try
                {
<span class="fc" id="L173">                    result = modelBuilder.build( request );</span>
                }
<span class="fc" id="L175">                catch ( ModelBuildingException e )</span>
                {
<span class="fc" id="L177">                    result = e.getResult();</span>
<span class="pc bpc" id="L178" title="1 of 4 branches missed.">                    if ( result == null || result.getEffectiveModel() == null )</span>
                    {
<span class="fc" id="L180">                        throw new ProjectBuildingException( e.getModelId(), e.getMessage(), pomFile, e );</span>
                    }
                    // validation error, continue project building and delay failing to help IDEs
<span class="fc" id="L183">                    error = e;</span>
<span class="fc" id="L184">                }</span>

<span class="fc" id="L186">                modelProblems = result.getProblems();</span>

<span class="fc" id="L188">                initProject( project, Collections.&lt;String, MavenProject&gt;emptyMap(), true,</span>
                             result, new HashMap&lt;File, Boolean&gt;(), projectBuildingRequest );
<span class="fc" id="L190">            }</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">            else if ( projectBuildingRequest.isResolveDependencies() )</span>
            {
<span class="nc" id="L193">                projectBuildingHelper.selectProjectRealm( project );</span>
            }

<span class="fc" id="L196">            DependencyResolutionResult resolutionResult = null;</span>

<span class="fc bfc" id="L198" title="All 2 branches covered.">            if ( projectBuildingRequest.isResolveDependencies() )</span>
            {
<span class="fc" id="L200">                resolutionResult = resolveDependencies( project, config.session );</span>
            }

<span class="fc" id="L203">            ProjectBuildingResult result = new DefaultProjectBuildingResult( project, modelProblems, resolutionResult );</span>

<span class="fc bfc" id="L205" title="All 2 branches covered.">            if ( error != null )</span>
            {
<span class="fc" id="L207">                ProjectBuildingException e = new ProjectBuildingException( Arrays.asList( result ) );</span>
<span class="fc" id="L208">                e.initCause( error );</span>
<span class="fc" id="L209">                throw e;</span>
            }

<span class="fc" id="L212">            return result;</span>
        }
        finally
        {
<span class="fc" id="L216">            Thread.currentThread().setContextClassLoader( oldContextClassLoader );</span>
        }
    }

    private DependencyResolutionResult resolveDependencies( MavenProject project, RepositorySystemSession session )
    {
        DependencyResolutionResult resolutionResult;

        try
        {
<span class="fc" id="L226">            DefaultDependencyResolutionRequest resolution = new DefaultDependencyResolutionRequest( project, session );</span>
<span class="fc" id="L227">            resolutionResult = dependencyResolver.resolve( resolution );</span>
        }
<span class="fc" id="L229">        catch ( DependencyResolutionException e )</span>
        {
<span class="fc" id="L231">            resolutionResult = e.getResult();</span>
<span class="fc" id="L232">        }</span>

<span class="fc" id="L234">        Set&lt;Artifact&gt; artifacts = new LinkedHashSet&lt;&gt;();</span>
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">        if ( resolutionResult.getDependencyGraph() != null )</span>
        {
<span class="fc" id="L237">            RepositoryUtils.toArtifacts( artifacts, resolutionResult.getDependencyGraph().getChildren(),</span>
<span class="fc" id="L238">                                         Collections.singletonList( project.getArtifact().getId() ), null );</span>

            // Maven 2.x quirk: an artifact always points at the local repo, regardless whether resolved or not
<span class="fc" id="L241">            LocalRepositoryManager lrm = session.getLocalRepositoryManager();</span>
<span class="fc bfc" id="L242" title="All 2 branches covered.">            for ( Artifact artifact : artifacts )</span>
            {
<span class="fc bfc" id="L244" title="All 2 branches covered.">                if ( !artifact.isResolved() )</span>
                {
<span class="fc" id="L246">                    String path = lrm.getPathForLocalArtifact( RepositoryUtils.toArtifact( artifact ) );</span>
<span class="fc" id="L247">                    artifact.setFile( new File( lrm.getRepository().getBasedir(), path ) );</span>
                }
<span class="fc" id="L249">            }</span>
        }
<span class="fc" id="L251">        project.setResolvedArtifacts( artifacts );</span>
<span class="fc" id="L252">        project.setArtifacts( artifacts );</span>

<span class="fc" id="L254">        return resolutionResult;</span>
    }

    private List&lt;String&gt; getProfileIds( List&lt;Profile&gt; profiles )
    {
<span class="fc" id="L259">        List&lt;String&gt; ids = new ArrayList&lt;&gt;( profiles.size() );</span>

<span class="fc bfc" id="L261" title="All 2 branches covered.">        for ( Profile profile : profiles )</span>
        {
<span class="fc" id="L263">            ids.add( profile.getId() );</span>
<span class="fc" id="L264">        }</span>

<span class="fc" id="L266">        return ids;</span>
    }

    private ModelBuildingRequest getModelBuildingRequest( InternalConfig config )
    {
<span class="fc" id="L271">        ProjectBuildingRequest configuration = config.request;</span>

<span class="fc" id="L273">        ModelBuildingRequest request = new DefaultModelBuildingRequest();</span>

<span class="fc" id="L275">        RequestTrace trace = RequestTrace.newChild( null, configuration ).newChild( request );</span>

<span class="fc" id="L277">        ModelResolver resolver =</span>
<span class="fc" id="L278">            new ProjectModelResolver( config.session, trace, repoSystem, repositoryManager, config.repositories,</span>
<span class="fc" id="L279">                                      configuration.getRepositoryMerging(), config.modelPool );</span>

<span class="fc" id="L281">        request.setValidationLevel( configuration.getValidationLevel() );</span>
<span class="fc" id="L282">        request.setProcessPlugins( configuration.isProcessPlugins() );</span>
<span class="fc" id="L283">        request.setProfiles( configuration.getProfiles() );</span>
<span class="fc" id="L284">        request.setActiveProfileIds( configuration.getActiveProfileIds() );</span>
<span class="fc" id="L285">        request.setInactiveProfileIds( configuration.getInactiveProfileIds() );</span>
<span class="fc" id="L286">        request.setSystemProperties( configuration.getSystemProperties() );</span>
<span class="fc" id="L287">        request.setUserProperties( configuration.getUserProperties() );</span>
<span class="fc" id="L288">        request.setBuildStartTime( configuration.getBuildStartTime() );</span>
<span class="fc" id="L289">        request.setModelResolver( resolver );</span>
<span class="fc" id="L290">        request.setModelCache( config.modelCache );</span>

<span class="fc" id="L292">        return request;</span>
    }

    @Override
    public ProjectBuildingResult build( Artifact artifact, ProjectBuildingRequest request )
        throws ProjectBuildingException
    {
<span class="fc" id="L299">        return build( artifact, false, request );</span>
    }

    @Override
    public ProjectBuildingResult build( Artifact artifact, boolean allowStubModel, ProjectBuildingRequest request )
        throws ProjectBuildingException
    {
<span class="fc" id="L306">        org.eclipse.aether.artifact.Artifact pomArtifact = RepositoryUtils.toArtifact( artifact );</span>
<span class="fc" id="L307">        pomArtifact = ArtifactDescriptorUtils.toPomArtifact( pomArtifact );</span>

<span class="pc bpc" id="L309" title="1 of 2 branches missed.">        InternalConfig config = new InternalConfig( request, null, useGlobalModelCache() ? getModelCache() : null );</span>

        boolean localProject;

        try
        {
<span class="fc" id="L315">            ArtifactRequest pomRequest = new ArtifactRequest();</span>
<span class="fc" id="L316">            pomRequest.setArtifact( pomArtifact );</span>
<span class="fc" id="L317">            pomRequest.setRepositories( config.repositories );</span>
<span class="fc" id="L318">            ArtifactResult pomResult = repoSystem.resolveArtifact( config.session, pomRequest );</span>

<span class="fc" id="L320">            pomArtifact = pomResult.getArtifact();</span>
<span class="fc" id="L321">            localProject = pomResult.getRepository() instanceof WorkspaceRepository;</span>
        }
<span class="fc" id="L323">        catch ( org.eclipse.aether.resolution.ArtifactResolutionException e )</span>
        {
<span class="pc bpc" id="L325" title="2 of 4 branches missed.">            if ( e.getResults().get( 0 ).isMissing() &amp;&amp; allowStubModel )</span>
            {
<span class="fc" id="L327">                return build( null, createStubModelSource( artifact ), config );</span>
            }
<span class="nc" id="L329">            throw new ProjectBuildingException( artifact.getId(),</span>
<span class="nc" id="L330">                                                &quot;Error resolving project artifact: &quot; + e.getMessage(), e );</span>
<span class="fc" id="L331">        }</span>

<span class="fc" id="L333">        File pomFile = pomArtifact.getFile();</span>

<span class="pc bpc" id="L335" title="1 of 2 branches missed.">        if ( &quot;pom&quot;.equals( artifact.getType() ) )</span>
        {
<span class="fc" id="L337">            artifact.selectVersion( pomArtifact.getVersion() );</span>
<span class="fc" id="L338">            artifact.setFile( pomFile );</span>
<span class="fc" id="L339">            artifact.setResolved( true );</span>
        }

<span class="pc bpc" id="L342" title="1 of 2 branches missed.">        return build( localProject ? pomFile : null, new FileModelSource( pomFile ), config );</span>
    }

    private ModelSource createStubModelSource( Artifact artifact )
    {
<span class="fc" id="L347">        StringBuilder buffer = new StringBuilder( 1024 );</span>

<span class="fc" id="L349">        buffer.append( &quot;&lt;?xml version='1.0'?&gt;&quot; );</span>
<span class="fc" id="L350">        buffer.append( &quot;&lt;project&gt;&quot; );</span>
<span class="fc" id="L351">        buffer.append( &quot;&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;&quot; );</span>
<span class="fc" id="L352">        buffer.append( &quot;&lt;groupId&gt;&quot; ).append( artifact.getGroupId() ).append( &quot;&lt;/groupId&gt;&quot; );</span>
<span class="fc" id="L353">        buffer.append( &quot;&lt;artifactId&gt;&quot; ).append( artifact.getArtifactId() ).append( &quot;&lt;/artifactId&gt;&quot; );</span>
<span class="fc" id="L354">        buffer.append( &quot;&lt;version&gt;&quot; ).append( artifact.getBaseVersion() ).append( &quot;&lt;/version&gt;&quot; );</span>
<span class="fc" id="L355">        buffer.append( &quot;&lt;packaging&gt;&quot; ).append( artifact.getType() ).append( &quot;&lt;/packaging&gt;&quot; );</span>
<span class="fc" id="L356">        buffer.append( &quot;&lt;/project&gt;&quot; );</span>

<span class="fc" id="L358">        return new StringModelSource( buffer, artifact.getId() );</span>
    }

    @Override
    public List&lt;ProjectBuildingResult&gt; build( List&lt;File&gt; pomFiles, boolean recursive, ProjectBuildingRequest request )
        throws ProjectBuildingException
    {
<span class="fc" id="L365">        List&lt;ProjectBuildingResult&gt; results = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L367">        List&lt;InterimResult&gt; interimResults = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L369">        ReactorModelPool modelPool = new ReactorModelPool();</span>

<span class="fc" id="L371">        InternalConfig config = new InternalConfig( request, modelPool,</span>
<span class="pc bpc" id="L372" title="1 of 2 branches missed.">                useGlobalModelCache() ? getModelCache() : new ReactorModelCache() );</span>

<span class="fc" id="L374">        Map&lt;String, MavenProject&gt; projectIndex = new HashMap&lt;&gt;( 256 );</span>

<span class="fc" id="L376">        boolean noErrors =</span>
<span class="fc" id="L377">            build( results, interimResults, projectIndex, pomFiles, new LinkedHashSet&lt;File&gt;(), true, recursive,</span>
                   config );

<span class="fc" id="L380">        populateReactorModelPool( modelPool, interimResults );</span>

<span class="fc" id="L382">        ClassLoader oldContextClassLoader = Thread.currentThread().getContextClassLoader();</span>

        try
        {
<span class="fc" id="L386">            noErrors =</span>
<span class="pc bpc" id="L387" title="1 of 4 branches missed.">                build( results, new ArrayList&lt;MavenProject&gt;(), projectIndex, interimResults, request,</span>
<span class="fc" id="L388">                       new HashMap&lt;File, Boolean&gt;(), config.session ) &amp;&amp; noErrors;</span>
        }
        finally
        {
<span class="fc" id="L392">            Thread.currentThread().setContextClassLoader( oldContextClassLoader );</span>
        }

<span class="fc bfc" id="L395" title="All 2 branches covered.">        if ( !noErrors )</span>
        {
<span class="fc" id="L397">            throw new ProjectBuildingException( results );</span>
        }

<span class="fc" id="L400">        return results;</span>
    }

    @SuppressWarnings( &quot;checkstyle:parameternumber&quot; )
    private boolean build( List&lt;ProjectBuildingResult&gt; results, List&lt;InterimResult&gt; interimResults,
                           Map&lt;String, MavenProject&gt; projectIndex, List&lt;File&gt; pomFiles, Set&lt;File&gt; aggregatorFiles,
                           boolean isRoot, boolean recursive, InternalConfig config )
    {
<span class="fc" id="L408">        boolean noErrors = true;</span>

<span class="fc bfc" id="L410" title="All 2 branches covered.">        for ( File pomFile : pomFiles )</span>
        {
<span class="fc" id="L412">            aggregatorFiles.add( pomFile );</span>

<span class="pc bpc" id="L414" title="1 of 2 branches missed.">            if ( !build( results, interimResults, projectIndex, pomFile, aggregatorFiles, isRoot, recursive, config ) )</span>
            {
<span class="nc" id="L416">                noErrors = false;</span>
            }

<span class="fc" id="L419">            aggregatorFiles.remove( pomFile );</span>
<span class="fc" id="L420">        }</span>

<span class="fc" id="L422">        return noErrors;</span>
    }

    @SuppressWarnings( &quot;checkstyle:parameternumber&quot; )
    private boolean build( List&lt;ProjectBuildingResult&gt; results, List&lt;InterimResult&gt; interimResults,
                           Map&lt;String, MavenProject&gt; projectIndex, File pomFile, Set&lt;File&gt; aggregatorFiles,
                           boolean isRoot, boolean recursive, InternalConfig config )
    {
<span class="fc" id="L430">        boolean noErrors = true;</span>

<span class="fc" id="L432">        ModelBuildingRequest request = getModelBuildingRequest( config );</span>

<span class="fc" id="L434">        MavenProject project = new MavenProject();</span>
<span class="fc" id="L435">        project.setFile( pomFile );</span>

<span class="fc" id="L437">        request.setPomFile( pomFile );</span>
<span class="fc" id="L438">        request.setTwoPhaseBuilding( true );</span>
<span class="fc" id="L439">        request.setLocationTracking( true );</span>

<span class="fc" id="L441">        DefaultModelBuildingListener listener =</span>
<span class="fc" id="L442">            new DefaultModelBuildingListener( project, projectBuildingHelper, config.request );</span>
<span class="fc" id="L443">        request.setModelBuildingListener( listener );</span>

        ModelBuildingResult result;
        try
        {
<span class="fc" id="L448">            result = modelBuilder.build( request );</span>
        }
<span class="nc" id="L450">        catch ( ModelBuildingException e )</span>
        {
<span class="nc" id="L452">            result = e.getResult();</span>
<span class="nc bnc" id="L453" title="All 4 branches missed.">            if ( result == null || result.getEffectiveModel() == null )</span>
            {
<span class="nc" id="L455">                 results.add( new DefaultProjectBuildingResult( e.getModelId(), pomFile, e.getProblems() ) );</span>

<span class="nc" id="L457">                 return false;</span>
            }
            // validation error, continue project building and delay failing to help IDEs
            // result.getProblems().addAll(e.getProblems()) ?
<span class="nc" id="L461">            noErrors = false;</span>
<span class="fc" id="L462">        }</span>

<span class="fc" id="L464">        Model model = result.getEffectiveModel();</span>
        try
        {
            // first pass: build without building parent.
<span class="fc" id="L468">            initProject( project, projectIndex, false, result, new HashMap&lt;File, Boolean&gt;( 0 ), config.request );</span>
        }
<span class="fc" id="L470">        catch ( InvalidArtifactRTException iarte )</span>
        {
<span class="fc" id="L472">            result.getProblems().add( new DefaultModelProblem( null, ModelProblem.Severity.ERROR, null, model, -1, -1,</span>
                  iarte ) );
<span class="fc" id="L474">        }</span>

<span class="fc" id="L476">        projectIndex.put( result.getModelIds().get( 0 ), project );</span>

<span class="fc" id="L478">        InterimResult interimResult = new InterimResult( pomFile, request, result, listener, isRoot );</span>
<span class="fc" id="L479">        interimResults.add( interimResult );</span>

<span class="fc bfc" id="L481" title="All 4 branches covered.">        if ( recursive &amp;&amp; !model.getModules().isEmpty() )</span>
        {
<span class="fc" id="L483">            File basedir = pomFile.getParentFile();</span>

<span class="fc" id="L485">            List&lt;File&gt; moduleFiles = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L487" title="All 2 branches covered.">            for ( String module : model.getModules() )</span>
            {
<span class="pc bpc" id="L489" title="1 of 2 branches missed.">                if ( StringUtils.isEmpty( module ) )</span>
                {
<span class="nc" id="L491">                    continue;</span>
                }

<span class="fc" id="L494">                module = module.replace( '\\', File.separatorChar ).replace( '/', File.separatorChar );</span>

<span class="fc" id="L496">                File moduleFile = new File( basedir, module );</span>

<span class="pc bpc" id="L498" title="1 of 2 branches missed.">                if ( moduleFile.isDirectory() )</span>
                {
<span class="fc" id="L500">                    moduleFile = modelProcessor.locatePom( moduleFile );</span>
                }

<span class="pc bpc" id="L503" title="1 of 2 branches missed.">                if ( !moduleFile.isFile() )</span>
                {
<span class="nc" id="L505">                    ModelProblem problem =</span>
                        new DefaultModelProblem( &quot;Child module &quot; + moduleFile + &quot; of &quot; + pomFile
                            + &quot; does not exist&quot;, ModelProblem.Severity.ERROR, ModelProblem.Version.BASE, model, -1,
                                                 -1, null );
<span class="nc" id="L509">                    result.getProblems().add( problem );</span>

<span class="nc" id="L511">                    noErrors = false;</span>

<span class="nc" id="L513">                    continue;</span>
                }

<span class="pc bpc" id="L516" title="1 of 2 branches missed.">                if ( Os.isFamily( Os.FAMILY_WINDOWS ) )</span>
                {
                    // we don't canonicalize on unix to avoid interfering with symlinks
                    try
                    {
<span class="nc" id="L521">                        moduleFile = moduleFile.getCanonicalFile();</span>
                    }
<span class="nc" id="L523">                    catch ( IOException e )</span>
                    {
<span class="nc" id="L525">                        moduleFile = moduleFile.getAbsoluteFile();</span>
<span class="nc" id="L526">                    }</span>
                }
                else
                {
<span class="fc" id="L530">                    moduleFile = new File( moduleFile.toURI().normalize() );</span>
                }

<span class="pc bpc" id="L533" title="1 of 2 branches missed.">                if ( aggregatorFiles.contains( moduleFile ) )</span>
                {
<span class="nc" id="L535">                    StringBuilder buffer = new StringBuilder( 256 );</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">                    for ( File aggregatorFile : aggregatorFiles )</span>
                    {
<span class="nc" id="L538">                        buffer.append( aggregatorFile ).append( &quot; -&gt; &quot; );</span>
<span class="nc" id="L539">                    }</span>
<span class="nc" id="L540">                    buffer.append( moduleFile );</span>

<span class="nc" id="L542">                    ModelProblem problem =</span>
                        new DefaultModelProblem( &quot;Child module &quot; + moduleFile + &quot; of &quot; + pomFile
                            + &quot; forms aggregation cycle &quot; + buffer, ModelProblem.Severity.ERROR,
                                                 ModelProblem.Version.BASE, model, -1, -1, null );
<span class="nc" id="L546">                    result.getProblems().add( problem );</span>

<span class="nc" id="L548">                    noErrors = false;</span>

<span class="nc" id="L550">                    continue;</span>
                }

<span class="fc" id="L553">                moduleFiles.add( moduleFile );</span>
<span class="fc" id="L554">            }</span>

<span class="fc" id="L556">            interimResult.modules = new ArrayList&lt;&gt;();</span>

<span class="pc bpc" id="L558" title="1 of 2 branches missed.">            if ( !build( results, interimResult.modules, projectIndex, moduleFiles, aggregatorFiles, false,</span>
                         recursive, config ) )
            {
<span class="nc" id="L561">                noErrors = false;</span>
            }
        }

<span class="fc" id="L565">        return noErrors;</span>
    }

    static class InterimResult
    {

        File pomFile;

        ModelBuildingRequest request;

        ModelBuildingResult result;

        DefaultModelBuildingListener listener;

        boolean root;

<span class="fc" id="L581">        List&lt;InterimResult&gt; modules = Collections.emptyList();</span>

        InterimResult( File pomFile, ModelBuildingRequest request, ModelBuildingResult result,
                       DefaultModelBuildingListener listener, boolean root )
<span class="fc" id="L585">        {</span>
<span class="fc" id="L586">            this.pomFile = pomFile;</span>
<span class="fc" id="L587">            this.request = request;</span>
<span class="fc" id="L588">            this.result = result;</span>
<span class="fc" id="L589">            this.listener = listener;</span>
<span class="fc" id="L590">            this.root = root;</span>
<span class="fc" id="L591">        }</span>

    }

    private void populateReactorModelPool( ReactorModelPool reactorModelPool, List&lt;InterimResult&gt; interimResults )
    {
<span class="fc bfc" id="L597" title="All 2 branches covered.">        for ( InterimResult interimResult : interimResults )</span>
        {
<span class="fc" id="L599">            Model model = interimResult.result.getEffectiveModel();</span>
<span class="fc" id="L600">            reactorModelPool.put( model.getGroupId(), model.getArtifactId(), model.getVersion(), model.getPomFile() );</span>

<span class="fc" id="L602">            populateReactorModelPool( reactorModelPool, interimResult.modules );</span>
<span class="fc" id="L603">        }</span>
<span class="fc" id="L604">    }</span>

    private boolean build( List&lt;ProjectBuildingResult&gt; results, List&lt;MavenProject&gt; projects,
                           Map&lt;String, MavenProject&gt; projectIndex, List&lt;InterimResult&gt; interimResults,
                           ProjectBuildingRequest request, Map&lt;File, Boolean&gt; profilesXmls,
                           RepositorySystemSession session )
    {
<span class="fc" id="L611">        boolean noErrors = true;</span>

<span class="fc bfc" id="L613" title="All 2 branches covered.">        for ( InterimResult interimResult : interimResults )</span>
        {
<span class="fc" id="L615">            MavenProject project = interimResult.listener.getProject();</span>
            try
            {
<span class="fc" id="L618">                ModelBuildingResult result = modelBuilder.build( interimResult.request, interimResult.result );</span>

                // 2nd pass of initialization: resolve and build parent if necessary
                try
                {
<span class="fc" id="L623">                    initProject( project, projectIndex, true, result, profilesXmls, request );</span>
                }
<span class="nc" id="L625">                catch ( InvalidArtifactRTException iarte )</span>
                {
<span class="nc" id="L627">                    result.getProblems().add( new DefaultModelProblem( null, ModelProblem.Severity.ERROR, null,</span>
<span class="nc" id="L628">                            result.getEffectiveModel(), -1, -1, iarte ) );</span>
<span class="fc" id="L629">                }</span>

<span class="fc" id="L631">                List&lt;MavenProject&gt; modules = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L632">                noErrors =</span>
<span class="pc bpc" id="L633" title="2 of 4 branches missed.">                    build( results, modules, projectIndex, interimResult.modules, request, profilesXmls, session )</span>
                    &amp;&amp; noErrors;

<span class="fc" id="L636">                projects.addAll( modules );</span>
<span class="fc" id="L637">                projects.add( project );</span>

<span class="fc" id="L639">                project.setExecutionRoot( interimResult.root );</span>
<span class="fc" id="L640">                project.setCollectedProjects( modules );</span>
<span class="fc" id="L641">                DependencyResolutionResult resolutionResult = null;</span>
<span class="fc bfc" id="L642" title="All 2 branches covered.">                if ( request.isResolveDependencies() )</span>
                {
<span class="fc" id="L644">                    resolutionResult = resolveDependencies( project, session );</span>
                }

<span class="fc" id="L647">                results.add( new DefaultProjectBuildingResult( project, result.getProblems(), resolutionResult ) );</span>
            }
<span class="fc" id="L649">            catch ( ModelBuildingException e )</span>
            {
<span class="fc" id="L651">                DefaultProjectBuildingResult result = null;</span>
<span class="pc bpc" id="L652" title="1 of 2 branches missed.">                if ( project == null )</span>
                {
<span class="nc" id="L654">                    result = new DefaultProjectBuildingResult( e.getModelId(), interimResult.pomFile, e.getProblems() );</span>
                }
                else
                {
<span class="fc" id="L658">                    result = new DefaultProjectBuildingResult( project, e.getProblems(), null );</span>
                }
<span class="fc" id="L660">                results.add( result );</span>

<span class="fc" id="L662">                noErrors = false;</span>
<span class="fc" id="L663">            }</span>
<span class="fc" id="L664">        }</span>

<span class="fc" id="L666">        return noErrors;</span>
    }

    @SuppressWarnings( &quot;checkstyle:methodlength&quot; )
    private void initProject( MavenProject project, Map&lt;String, MavenProject&gt; projects,
                              boolean buildParentIfNotExisting, ModelBuildingResult result,
                              Map&lt;File, Boolean&gt; profilesXmls, ProjectBuildingRequest projectBuildingRequest )
    {
<span class="fc" id="L674">        Model model = result.getEffectiveModel();</span>

<span class="fc" id="L676">        project.setModel( model );</span>
<span class="fc" id="L677">        project.setOriginalModel( result.getRawModel() );</span>
<span class="fc" id="L678">        project.setFile( model.getPomFile() );</span>

<span class="fc" id="L680">        initParent( project, projects, buildParentIfNotExisting, result, projectBuildingRequest );</span>

<span class="fc" id="L682">        Artifact projectArtifact =</span>
<span class="fc" id="L683">            repositorySystem.createArtifact( project.getGroupId(), project.getArtifactId(), project.getVersion(), null,</span>
<span class="fc" id="L684">                                             project.getPackaging() );</span>
<span class="fc" id="L685">        project.setArtifact( projectArtifact );</span>

<span class="fc bfc" id="L687" title="All 4 branches covered.">        if ( project.getFile() != null &amp;&amp; buildParentIfNotExisting ) // only set those on 2nd phase, ignore on 1st pass</span>
        {
<span class="fc" id="L689">            Build build = project.getBuild();</span>
<span class="fc" id="L690">            project.addScriptSourceRoot( build.getScriptSourceDirectory() );</span>
<span class="fc" id="L691">            project.addCompileSourceRoot( build.getSourceDirectory() );</span>
<span class="fc" id="L692">            project.addTestCompileSourceRoot( build.getTestSourceDirectory() );</span>
        }

<span class="fc" id="L695">        List&lt;Profile&gt; activeProfiles = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L696">        activeProfiles.addAll( result.getActivePomProfiles( result.getModelIds().get( 0 ) ) );</span>
<span class="fc" id="L697">        activeProfiles.addAll( result.getActiveExternalProfiles() );</span>
<span class="fc" id="L698">        project.setActiveProfiles( activeProfiles );</span>

<span class="fc" id="L700">        project.setInjectedProfileIds( &quot;external&quot;, getProfileIds( result.getActiveExternalProfiles() ) );</span>
<span class="fc bfc" id="L701" title="All 2 branches covered.">        for ( String modelId : result.getModelIds() )</span>
        {
<span class="fc" id="L703">            project.setInjectedProfileIds( modelId, getProfileIds( result.getActivePomProfiles( modelId ) ) );</span>
<span class="fc" id="L704">        }</span>

<span class="fc" id="L706">        String modelId = findProfilesXml( result, profilesXmls );</span>
<span class="pc bpc" id="L707" title="1 of 2 branches missed.">        if ( modelId != null )</span>
        {
<span class="nc" id="L709">            ModelProblem problem =</span>
                new DefaultModelProblem( &quot;Detected profiles.xml alongside &quot; + modelId
                    + &quot;, this file is no longer supported and was ignored&quot; + &quot;, please use the settings.xml instead&quot;,
                                         ModelProblem.Severity.WARNING, ModelProblem.Version.V30, model, -1, -1, null );
<span class="nc" id="L713">            result.getProblems().add( problem );</span>
        }

        //
        // All the parts that were taken out of MavenProject for Maven 4.0.0
        //

<span class="fc" id="L720">        project.setProjectBuildingRequest( projectBuildingRequest );</span>

        // pluginArtifacts
<span class="fc" id="L723">        Set&lt;Artifact&gt; pluginArtifacts = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L724" title="All 2 branches covered.">        for ( Plugin plugin : project.getBuildPlugins() )</span>
        {
<span class="fc" id="L726">            Artifact artifact = repositorySystem.createPluginArtifact( plugin );</span>

<span class="pc bpc" id="L728" title="1 of 2 branches missed.">            if ( artifact != null )</span>
            {
<span class="fc" id="L730">                pluginArtifacts.add( artifact );</span>
            }
<span class="fc" id="L732">        }</span>
<span class="fc" id="L733">        project.setPluginArtifacts( pluginArtifacts );</span>

        // reportArtifacts
<span class="fc" id="L736">        Set&lt;Artifact&gt; reportArtifacts = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L737" title="All 2 branches covered.">        for ( ReportPlugin report : project.getReportPlugins() )</span>
        {
<span class="fc" id="L739">            Plugin pp = new Plugin();</span>
<span class="fc" id="L740">            pp.setGroupId( report.getGroupId() );</span>
<span class="fc" id="L741">            pp.setArtifactId( report.getArtifactId() );</span>
<span class="fc" id="L742">            pp.setVersion( report.getVersion() );</span>

<span class="fc" id="L744">            Artifact artifact = repositorySystem.createPluginArtifact( pp );</span>

<span class="pc bpc" id="L746" title="1 of 2 branches missed.">            if ( artifact != null )</span>
            {
<span class="fc" id="L748">                reportArtifacts.add( artifact );</span>
            }
<span class="fc" id="L750">        }</span>
<span class="fc" id="L751">        project.setReportArtifacts( reportArtifacts );</span>

        // extensionArtifacts
<span class="fc" id="L754">        Set&lt;Artifact&gt; extensionArtifacts = new HashSet&lt;&gt;();</span>
<span class="fc" id="L755">        List&lt;Extension&gt; extensions = project.getBuildExtensions();</span>
<span class="pc bpc" id="L756" title="1 of 2 branches missed.">        if ( extensions != null )</span>
        {
<span class="fc bfc" id="L758" title="All 2 branches covered.">            for ( Extension ext : extensions )</span>
            {
                String version;
<span class="pc bpc" id="L761" title="1 of 2 branches missed.">                if ( StringUtils.isEmpty( ext.getVersion() ) )</span>
                {
<span class="nc" id="L763">                    version = &quot;RELEASE&quot;;</span>
                }
                else
                {
<span class="fc" id="L767">                    version = ext.getVersion();</span>
                }

<span class="fc" id="L770">                Artifact artifact =</span>
<span class="fc" id="L771">                    repositorySystem.createArtifact( ext.getGroupId(), ext.getArtifactId(), version, null, &quot;jar&quot; );</span>

<span class="pc bpc" id="L773" title="1 of 2 branches missed.">                if ( artifact != null )</span>
                {
<span class="fc" id="L775">                    extensionArtifacts.add( artifact );</span>
                }
<span class="fc" id="L777">            }</span>
        }
<span class="fc" id="L779">        project.setExtensionArtifacts( extensionArtifacts );</span>

        // managedVersionMap
<span class="fc" id="L782">        Map&lt;String, Artifact&gt; map = null;</span>
<span class="pc bpc" id="L783" title="1 of 2 branches missed.">        if ( repositorySystem != null )</span>
        {
<span class="fc" id="L785">            final DependencyManagement dependencyManagement = project.getDependencyManagement();</span>
<span class="pc bpc" id="L786" title="1 of 4 branches missed.">            if ( ( dependencyManagement != null ) &amp;&amp; ( ( dependencyManagement.getDependencies() ) != null )</span>
<span class="fc bfc" id="L787" title="All 2 branches covered.">                &amp;&amp; ( dependencyManagement.getDependencies().size() &gt; 0 ) )</span>
            {
<span class="fc" id="L789">                map = new AbstractMap&lt;String, Artifact&gt;()</span>
<span class="fc" id="L790">                {</span>
                    HashMap&lt;String, Artifact&gt; delegate;

                    @Override
                    public Set&lt;Entry&lt;String, Artifact&gt;&gt; entrySet()
                    {
<span class="fc" id="L796">                        return Collections.unmodifiableSet( compute().entrySet() );</span>
                    }

                    @Override
                    public Set&lt;String&gt; keySet()
                    {
<span class="nc" id="L802">                        return Collections.unmodifiableSet( compute().keySet() );</span>
                    }

                    @Override
                    public Collection&lt;Artifact&gt; values()
                    {
<span class="nc" id="L808">                        return Collections.unmodifiableCollection( compute().values() );</span>
                    }

                    @Override
                    public boolean containsValue( Object value )
                    {
<span class="nc" id="L814">                        return compute().containsValue( value );</span>
                    }

                    @Override
                    public boolean containsKey( Object key )
                    {
<span class="fc" id="L820">                        return compute().containsKey( key );</span>
                    }

                    @Override
                    public Artifact get( Object key )
                    {
<span class="nc" id="L826">                        return compute().get( key );</span>
                    }

                    HashMap&lt;String, Artifact&gt; compute()
                    {
<span class="fc bfc" id="L831" title="All 2 branches covered.">                        if ( delegate == null )</span>
                        {
<span class="fc" id="L833">                            delegate = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L834" title="All 2 branches covered.">                            for ( Dependency d : dependencyManagement.getDependencies() )</span>
                            {
<span class="fc" id="L836">                                Artifact artifact = repositorySystem.createDependencyArtifact( d );</span>

<span class="pc bpc" id="L838" title="1 of 2 branches missed.">                                if ( artifact != null )</span>
                                {
<span class="fc" id="L840">                                    delegate.put( d.getManagementKey(), artifact );</span>
                                }
<span class="fc" id="L842">                            }</span>
                        }

<span class="fc" id="L845">                        return delegate;</span>
                    }
                };
            }
            else
            {
<span class="fc" id="L851">                map = Collections.emptyMap();</span>
            }
        }
<span class="fc" id="L854">        project.setManagedVersionMap( map );</span>

        // release artifact repository
<span class="fc bfc" id="L857" title="All 2 branches covered.">        if ( project.getDistributionManagement() != null</span>
<span class="fc bfc" id="L858" title="All 2 branches covered.">                        &amp;&amp; project.getDistributionManagement().getRepository() != null )</span>
        {
            try
            {
<span class="fc" id="L862">                DeploymentRepository r = project.getDistributionManagement().getRepository();</span>
<span class="pc bpc" id="L863" title="1 of 4 branches missed.">                if ( !StringUtils.isEmpty( r.getId() ) &amp;&amp; !StringUtils.isEmpty( r.getUrl() ) )</span>
                {
<span class="fc" id="L865">                    ArtifactRepository repo = repositorySystem.buildArtifactRepository( r );</span>
<span class="fc" id="L866">                    repositorySystem.injectProxy( projectBuildingRequest.getRepositorySession(),</span>
<span class="fc" id="L867">                                                  Arrays.asList( repo ) );</span>
<span class="fc" id="L868">                    repositorySystem.injectAuthentication( projectBuildingRequest.getRepositorySession(),</span>
<span class="fc" id="L869">                                                           Arrays.asList( repo ) );</span>
<span class="fc" id="L870">                    project.setReleaseArtifactRepository( repo );</span>
                }
            }
<span class="nc" id="L873">            catch ( InvalidRepositoryException e )</span>
            {
<span class="nc" id="L875">                throw new IllegalStateException( &quot;Failed to create release distribution repository for &quot;</span>
<span class="nc" id="L876">                    + project.getId(), e );</span>
<span class="fc" id="L877">            }</span>
        }

        // snapshot artifact repository
<span class="fc bfc" id="L881" title="All 2 branches covered.">        if ( project.getDistributionManagement() != null</span>
<span class="fc bfc" id="L882" title="All 2 branches covered.">            &amp;&amp; project.getDistributionManagement().getSnapshotRepository() != null )</span>
        {
            try
            {
<span class="fc" id="L886">                DeploymentRepository r = project.getDistributionManagement().getSnapshotRepository();</span>
<span class="pc bpc" id="L887" title="2 of 4 branches missed.">                if ( !StringUtils.isEmpty( r.getId() ) &amp;&amp; !StringUtils.isEmpty( r.getUrl() ) )</span>
                {
<span class="fc" id="L889">                    ArtifactRepository repo = repositorySystem.buildArtifactRepository( r );</span>
<span class="fc" id="L890">                    repositorySystem.injectProxy( projectBuildingRequest.getRepositorySession(),</span>
<span class="fc" id="L891">                                                  Arrays.asList( repo ) );</span>
<span class="fc" id="L892">                    repositorySystem.injectAuthentication( projectBuildingRequest.getRepositorySession(),</span>
<span class="fc" id="L893">                                                           Arrays.asList( repo ) );</span>
<span class="fc" id="L894">                    project.setSnapshotArtifactRepository( repo );</span>
                }
            }
<span class="nc" id="L897">            catch ( InvalidRepositoryException e )</span>
            {
<span class="nc" id="L899">                throw new IllegalStateException( &quot;Failed to create snapshot distribution repository for &quot;</span>
<span class="nc" id="L900">                    + project.getId(), e );</span>
<span class="fc" id="L901">            }</span>
        }
<span class="fc" id="L903">    }</span>

    private void initParent( MavenProject project, Map&lt;String, MavenProject&gt; projects, boolean buildParentIfNotExisting,
                             ModelBuildingResult result, ProjectBuildingRequest projectBuildingRequest )
    {
<span class="pc bpc" id="L908" title="1 of 4 branches missed.">        Model parentModel = result.getModelIds().size() &gt; 1 &amp;&amp; !result.getModelIds().get( 1 ).isEmpty()</span>
<span class="fc" id="L909">                                ? result.getRawModel( result.getModelIds().get( 1 ) )</span>
                                : null;

<span class="fc bfc" id="L912" title="All 2 branches covered.">        if ( parentModel != null )</span>
        {
<span class="fc" id="L914">            final String parentGroupId = inheritedGroupId( result, 1 );</span>
<span class="fc" id="L915">            final String parentVersion = inheritedVersion( result, 1 );</span>

<span class="fc" id="L917">            project.setParentArtifact( repositorySystem.createProjectArtifact( parentGroupId,</span>
<span class="fc" id="L918">                                                                               parentModel.getArtifactId(),</span>
                                                                               parentVersion ) );

            // org.apache.maven.its.mng4834:parent:0.1
<span class="fc" id="L922">            String parentModelId = result.getModelIds().get( 1 );</span>
<span class="fc" id="L923">            File parentPomFile = result.getRawModel( parentModelId ).getPomFile();</span>
<span class="fc" id="L924">            MavenProject parent = projects.get( parentModelId );</span>
<span class="fc bfc" id="L925" title="All 4 branches covered.">            if ( parent == null &amp;&amp; buildParentIfNotExisting )</span>
            {
                //
                // At this point the DefaultModelBuildingListener has fired and it populates the
                // remote repositories with those found in the pom.xml, along with the existing externally
                // defined repositories.
                //
<span class="fc" id="L932">                projectBuildingRequest.setRemoteRepositories( project.getRemoteArtifactRepositories() );</span>
<span class="fc bfc" id="L933" title="All 2 branches covered.">                if ( parentPomFile != null )</span>
                {
<span class="fc" id="L935">                    project.setParentFile( parentPomFile );</span>
                    try
                    {
<span class="fc" id="L938">                        parent = build( parentPomFile, projectBuildingRequest ).getProject();</span>
                    }
<span class="nc" id="L940">                    catch ( ProjectBuildingException e )</span>
                    {
                        // MNG-4488 where let invalid parents slide on by
<span class="nc bnc" id="L943" title="All 2 branches missed.">                        if ( logger.isDebugEnabled() )</span>
                        {
                            // Message below is checked for in the MNG-2199 core IT.
<span class="nc" id="L946">                            logger.warn( &quot;Failed to build parent project for &quot; + project.getId(), e );</span>
                        }
                        else
                        {
                            // Message below is checked for in the MNG-2199 core IT.
<span class="nc" id="L951">                            logger.warn( &quot;Failed to build parent project for &quot; + project.getId() );</span>
                        }
<span class="pc" id="L953">                    }</span>
                }
                else
                {
<span class="fc" id="L957">                    Artifact parentArtifact = project.getParentArtifact();</span>
                    try
                    {
<span class="fc" id="L960">                        parent = build( parentArtifact, projectBuildingRequest ).getProject();</span>
                    }
<span class="nc" id="L962">                    catch ( ProjectBuildingException e )</span>
                    {
                        // MNG-4488 where let invalid parents slide on by
<span class="nc bnc" id="L965" title="All 2 branches missed.">                        if ( logger.isDebugEnabled() )</span>
                        {
                            // Message below is checked for in the MNG-2199 core IT.
<span class="nc" id="L968">                            logger.warn( &quot;Failed to build parent project for &quot; + project.getId(), e );</span>
                        }
                        else
                        {
                            // Message below is checked for in the MNG-2199 core IT.
<span class="nc" id="L973">                            logger.warn( &quot;Failed to build parent project for &quot; + project.getId() );</span>
                        }
<span class="fc" id="L975">                    }</span>
                }
            }
<span class="fc" id="L978">            project.setParent( parent );</span>
<span class="fc bfc" id="L979" title="All 4 branches covered.">            if ( project.getParentFile() == null &amp;&amp; parent != null )</span>
            {
<span class="fc" id="L981">                project.setParentFile( parent.getFile() );</span>
            }
        }
<span class="fc" id="L984">    }</span>

    private static String inheritedGroupId( final ModelBuildingResult result, final int modelIndex )
    {
<span class="fc" id="L988">        String groupId = null;</span>
<span class="fc" id="L989">        final String modelId = result.getModelIds().get( modelIndex );</span>

<span class="pc bpc" id="L991" title="1 of 2 branches missed.">        if ( !modelId.isEmpty() )</span>
        {
<span class="fc" id="L993">            final Model model = result.getRawModel( modelId );</span>
<span class="fc bfc" id="L994" title="All 2 branches covered.">            groupId = model.getGroupId() != null</span>
<span class="fc" id="L995">                          ? model.getGroupId()</span>
<span class="fc" id="L996">                          : inheritedGroupId( result, modelIndex + 1 );</span>

        }

<span class="fc" id="L1000">        return groupId;</span>
    }

    private static String inheritedVersion( final ModelBuildingResult result, final int modelIndex )
    {
<span class="fc" id="L1005">        String version = null;</span>
<span class="fc" id="L1006">        final String modelId = result.getModelIds().get( modelIndex );</span>

<span class="pc bpc" id="L1008" title="1 of 2 branches missed.">        if ( !modelId.isEmpty() )</span>
        {
<span class="fc" id="L1010">            final Model model = result.getRawModel( modelId );</span>
<span class="fc bfc" id="L1011" title="All 2 branches covered.">            version = model.getVersion() != null</span>
<span class="fc" id="L1012">                          ? model.getVersion()</span>
<span class="fc" id="L1013">                          : inheritedVersion( result, modelIndex + 1 );</span>

        }

<span class="fc" id="L1017">        return version;</span>
    }

    private String findProfilesXml( ModelBuildingResult result, Map&lt;File, Boolean&gt; profilesXmls )
    {
<span class="pc bpc" id="L1022" title="1 of 2 branches missed.">        for ( String modelId : result.getModelIds() )</span>
        {
<span class="fc" id="L1024">            Model model = result.getRawModel( modelId );</span>

<span class="fc" id="L1026">            File basedir = model.getProjectDirectory();</span>
<span class="fc bfc" id="L1027" title="All 2 branches covered.">            if ( basedir == null )</span>
            {
<span class="fc" id="L1029">                break;</span>
            }

<span class="fc" id="L1032">            Boolean profilesXml = profilesXmls.get( basedir );</span>
<span class="fc bfc" id="L1033" title="All 2 branches covered.">            if ( profilesXml == null )</span>
            {
<span class="fc" id="L1035">                profilesXml = new File( basedir, &quot;profiles.xml&quot; ).exists();</span>
<span class="fc" id="L1036">                profilesXmls.put( basedir, profilesXml );</span>
            }
<span class="pc bpc" id="L1038" title="1 of 2 branches missed.">            if ( profilesXml )</span>
            {
<span class="nc" id="L1040">                return modelId;</span>
            }
<span class="fc" id="L1042">        }</span>

<span class="fc" id="L1044">        return null;</span>
    }

    /**
     * InternalConfig
     */
    class InternalConfig
    {

        private final ProjectBuildingRequest request;

        private final RepositorySystemSession session;

        private final List&lt;RemoteRepository&gt; repositories;

        private final ReactorModelPool modelPool;

        private final ReactorModelCache modelCache;

        InternalConfig( ProjectBuildingRequest request, ReactorModelPool modelPool, ReactorModelCache modelCache )
<span class="fc" id="L1064">        {</span>
<span class="fc" id="L1065">            this.request = request;</span>
<span class="fc" id="L1066">            this.modelPool = modelPool;</span>
<span class="fc" id="L1067">            this.modelCache = modelCache;</span>
<span class="fc" id="L1068">            session =</span>
<span class="fc" id="L1069">                LegacyLocalRepositoryManager.overlay( request.getLocalRepository(), request.getRepositorySession(),</span>
<span class="fc" id="L1070">                                                      repoSystem );</span>
<span class="fc" id="L1071">            repositories = RepositoryUtils.toRepos( request.getRemoteRepositories() );</span>
<span class="fc" id="L1072">        }</span>

    }

    private ReactorModelCache getModelCache()
    {
<span class="fc" id="L1078">        return this.modelCache;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>