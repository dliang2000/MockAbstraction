<!--

       Copyright ${license.git.copyrightYears} the original author or authors.

       Licensed under the Apache License, Version 2.0 (the "License");
       you may not use this file except in compliance with the License.
       You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

       Unless required by applicable law or agreed to in writing, software
       distributed under the License is distributed on an "AS IS" BASIS,
       WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
       See the License for the specific language governing permissions and
       limitations under the License.

-->
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>XNode.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">mybatis</a> &gt; <a href="index.source.html" class="el_package">org.apache.ibatis.parsing</a> &gt; <span class="el_source">XNode.java</span></div><h1>XNode.java</h1><pre class="source lang-java linenums">/**
 *    Copyright 2009-2021 the original author or authors.
 *
 *    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *       http://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License.
 */
package org.apache.ibatis.parsing;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.function.Supplier;

import org.w3c.dom.CharacterData;
import org.w3c.dom.Element;
import org.w3c.dom.NamedNodeMap;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;

/**
 * @author Clinton Begin
 */
public class XNode {

  private final Node node;
  private final String name;
  private final String body;
  private final Properties attributes;
  private final Properties variables;
  private final XPathParser xpathParser;

<span class="fc" id="L42">  public XNode(XPathParser xpathParser, Node node, Properties variables) {</span>
<span class="fc" id="L43">    this.xpathParser = xpathParser;</span>
<span class="fc" id="L44">    this.node = node;</span>
<span class="fc" id="L45">    this.name = node.getNodeName();</span>
<span class="fc" id="L46">    this.variables = variables;</span>
<span class="fc" id="L47">    this.attributes = parseAttributes(node);</span>
<span class="fc" id="L48">    this.body = parseBody(node);</span>
<span class="fc" id="L49">  }</span>

  public XNode newXNode(Node node) {
<span class="fc" id="L52">    return new XNode(xpathParser, node, variables);</span>
  }

  public XNode getParent() {
<span class="fc" id="L56">    Node parent = node.getParentNode();</span>
<span class="fc bfc" id="L57" title="All 2 branches covered.">    if (!(parent instanceof Element)) {</span>
<span class="fc" id="L58">      return null;</span>
    } else {
<span class="fc" id="L60">      return new XNode(xpathParser, parent, variables);</span>
    }
  }

  public String getPath() {
<span class="fc" id="L65">    StringBuilder builder = new StringBuilder();</span>
<span class="fc" id="L66">    Node current = node;</span>
<span class="fc bfc" id="L67" title="All 2 branches covered.">    while (current instanceof Element) {</span>
<span class="fc bfc" id="L68" title="All 2 branches covered.">      if (current != node) {</span>
<span class="fc" id="L69">        builder.insert(0, &quot;/&quot;);</span>
      }
<span class="fc" id="L71">      builder.insert(0, current.getNodeName());</span>
<span class="fc" id="L72">      current = current.getParentNode();</span>
    }
<span class="fc" id="L74">    return builder.toString();</span>
  }

  public String getValueBasedIdentifier() {
<span class="fc" id="L78">    StringBuilder builder = new StringBuilder();</span>
<span class="fc" id="L79">    XNode current = this;</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">    while (current != null) {</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">      if (current != this) {</span>
<span class="fc" id="L82">        builder.insert(0, &quot;_&quot;);</span>
      }
<span class="fc" id="L84">      String value = current.getStringAttribute(&quot;id&quot;,</span>
<span class="fc" id="L85">          current.getStringAttribute(&quot;value&quot;,</span>
<span class="fc" id="L86">              current.getStringAttribute(&quot;property&quot;, (String) null)));</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">      if (value != null) {</span>
<span class="fc" id="L88">        value = value.replace('.', '_');</span>
<span class="fc" id="L89">        builder.insert(0, &quot;]&quot;);</span>
<span class="fc" id="L90">        builder.insert(0,</span>
            value);
<span class="fc" id="L92">        builder.insert(0, &quot;[&quot;);</span>
      }
<span class="fc" id="L94">      builder.insert(0, current.getName());</span>
<span class="fc" id="L95">      current = current.getParent();</span>
<span class="fc" id="L96">    }</span>
<span class="fc" id="L97">    return builder.toString();</span>
  }

  public String evalString(String expression) {
<span class="fc" id="L101">    return xpathParser.evalString(node, expression);</span>
  }

  public Boolean evalBoolean(String expression) {
<span class="fc" id="L105">    return xpathParser.evalBoolean(node, expression);</span>
  }

  public Double evalDouble(String expression) {
<span class="fc" id="L109">    return xpathParser.evalDouble(node, expression);</span>
  }

  public List&lt;XNode&gt; evalNodes(String expression) {
<span class="fc" id="L113">    return xpathParser.evalNodes(node, expression);</span>
  }

  public XNode evalNode(String expression) {
<span class="fc" id="L117">    return xpathParser.evalNode(node, expression);</span>
  }

  public Node getNode() {
<span class="fc" id="L121">    return node;</span>
  }

  public String getName() {
<span class="fc" id="L125">    return name;</span>
  }

  public String getStringBody() {
<span class="fc" id="L129">    return getStringBody(null);</span>
  }

  public String getStringBody(String def) {
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">    if (body == null) {</span>
<span class="nc" id="L134">      return def;</span>
    } else {
<span class="fc" id="L136">      return body;</span>
    }
  }

  public Boolean getBooleanBody() {
<span class="fc" id="L141">    return getBooleanBody(null);</span>
  }

  public Boolean getBooleanBody(Boolean def) {
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">    if (body == null) {</span>
<span class="nc" id="L146">      return def;</span>
    } else {
<span class="fc" id="L148">      return Boolean.valueOf(body);</span>
    }
  }

  public Integer getIntBody() {
<span class="fc" id="L153">    return getIntBody(null);</span>
  }

  public Integer getIntBody(Integer def) {
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">    if (body == null) {</span>
<span class="nc" id="L158">      return def;</span>
    } else {
<span class="fc" id="L160">      return Integer.parseInt(body);</span>
    }
  }

  public Long getLongBody() {
<span class="fc" id="L165">    return getLongBody(null);</span>
  }

  public Long getLongBody(Long def) {
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">    if (body == null) {</span>
<span class="nc" id="L170">      return def;</span>
    } else {
<span class="fc" id="L172">      return Long.parseLong(body);</span>
    }
  }

  public Double getDoubleBody() {
<span class="fc" id="L177">    return getDoubleBody(null);</span>
  }

  public Double getDoubleBody(Double def) {
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">    if (body == null) {</span>
<span class="nc" id="L182">      return def;</span>
    } else {
<span class="fc" id="L184">      return Double.parseDouble(body);</span>
    }
  }

  public Float getFloatBody() {
<span class="fc" id="L189">    return getFloatBody(null);</span>
  }

  public Float getFloatBody(Float def) {
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">    if (body == null) {</span>
<span class="nc" id="L194">      return def;</span>
    } else {
<span class="fc" id="L196">      return Float.parseFloat(body);</span>
    }
  }

  public &lt;T extends Enum&lt;T&gt;&gt; T getEnumAttribute(Class&lt;T&gt; enumType, String name) {
<span class="fc" id="L201">    return getEnumAttribute(enumType, name, null);</span>
  }

  public &lt;T extends Enum&lt;T&gt;&gt; T getEnumAttribute(Class&lt;T&gt; enumType, String name, T def) {
<span class="fc" id="L205">    String value = getStringAttribute(name);</span>
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L207">      return def;</span>
    } else {
<span class="fc" id="L209">      return Enum.valueOf(enumType, value);</span>
    }
  }

  /**
   * Return a attribute value as String.
   *
   * &lt;p&gt;
   * If attribute value is absent, return value that provided from supplier of default value.
   *
   * @param name
   *          attribute name
   * @param defSupplier
   *          a supplier of default value
   * @return the string attribute
   * @since 3.5.4
   */
  public String getStringAttribute(String name, Supplier&lt;String&gt; defSupplier) {
<span class="fc" id="L227">    String value = attributes.getProperty(name);</span>
<span class="fc bfc" id="L228" title="All 2 branches covered.">    return value == null ? defSupplier.get() : value;</span>
  }

  public String getStringAttribute(String name) {
<span class="fc" id="L232">    return getStringAttribute(name, (String) null);</span>
  }

  public String getStringAttribute(String name, String def) {
<span class="fc" id="L236">    String value = attributes.getProperty(name);</span>
<span class="fc bfc" id="L237" title="All 2 branches covered.">    if (value == null) {</span>
<span class="fc" id="L238">      return def;</span>
    } else {
<span class="fc" id="L240">      return value;</span>
    }
  }

  public Boolean getBooleanAttribute(String name) {
<span class="fc" id="L245">    return getBooleanAttribute(name, null);</span>
  }

  public Boolean getBooleanAttribute(String name, Boolean def) {
<span class="fc" id="L249">    String value = attributes.getProperty(name);</span>
<span class="fc bfc" id="L250" title="All 2 branches covered.">    if (value == null) {</span>
<span class="fc" id="L251">      return def;</span>
    } else {
<span class="fc" id="L253">      return Boolean.valueOf(value);</span>
    }
  }

  public Integer getIntAttribute(String name) {
<span class="fc" id="L258">    return getIntAttribute(name, null);</span>
  }

  public Integer getIntAttribute(String name, Integer def) {
<span class="fc" id="L262">    String value = attributes.getProperty(name);</span>
<span class="fc bfc" id="L263" title="All 2 branches covered.">    if (value == null) {</span>
<span class="fc" id="L264">      return def;</span>
    } else {
<span class="fc" id="L266">      return Integer.parseInt(value);</span>
    }
  }

  public Long getLongAttribute(String name) {
<span class="fc" id="L271">    return getLongAttribute(name, null);</span>
  }

  public Long getLongAttribute(String name, Long def) {
<span class="fc" id="L275">    String value = attributes.getProperty(name);</span>
<span class="fc bfc" id="L276" title="All 2 branches covered.">    if (value == null) {</span>
<span class="fc" id="L277">      return def;</span>
    } else {
<span class="fc" id="L279">      return Long.parseLong(value);</span>
    }
  }

  public Double getDoubleAttribute(String name) {
<span class="fc" id="L284">    return getDoubleAttribute(name, null);</span>
  }

  public Double getDoubleAttribute(String name, Double def) {
<span class="fc" id="L288">    String value = attributes.getProperty(name);</span>
<span class="pc bpc" id="L289" title="1 of 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L290">      return def;</span>
    } else {
<span class="fc" id="L292">      return Double.parseDouble(value);</span>
    }
  }

  public Float getFloatAttribute(String name) {
<span class="fc" id="L297">    return getFloatAttribute(name, null);</span>
  }

  public Float getFloatAttribute(String name, Float def) {
<span class="fc" id="L301">    String value = attributes.getProperty(name);</span>
<span class="pc bpc" id="L302" title="1 of 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L303">      return def;</span>
    } else {
<span class="fc" id="L305">      return Float.parseFloat(value);</span>
    }
  }

  public List&lt;XNode&gt; getChildren() {
<span class="fc" id="L310">    List&lt;XNode&gt; children = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L311">    NodeList nodeList = node.getChildNodes();</span>
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">    if (nodeList != null) {</span>
<span class="fc bfc" id="L313" title="All 2 branches covered.">      for (int i = 0, n = nodeList.getLength(); i &lt; n; i++) {</span>
<span class="fc" id="L314">        Node node = nodeList.item(i);</span>
<span class="fc bfc" id="L315" title="All 2 branches covered.">        if (node.getNodeType() == Node.ELEMENT_NODE) {</span>
<span class="fc" id="L316">          children.add(new XNode(xpathParser, node, variables));</span>
        }
      }
    }
<span class="fc" id="L320">    return children;</span>
  }

  public Properties getChildrenAsProperties() {
<span class="fc" id="L324">    Properties properties = new Properties();</span>
<span class="fc bfc" id="L325" title="All 2 branches covered.">    for (XNode child : getChildren()) {</span>
<span class="fc" id="L326">      String name = child.getStringAttribute(&quot;name&quot;);</span>
<span class="fc" id="L327">      String value = child.getStringAttribute(&quot;value&quot;);</span>
<span class="pc bpc" id="L328" title="2 of 4 branches missed.">      if (name != null &amp;&amp; value != null) {</span>
<span class="fc" id="L329">        properties.setProperty(name, value);</span>
      }
<span class="fc" id="L331">    }</span>
<span class="fc" id="L332">    return properties;</span>
  }

  @Override
  public String toString() {
<span class="fc" id="L337">    StringBuilder builder = new StringBuilder();</span>
<span class="fc" id="L338">    toString(builder, 0);</span>
<span class="fc" id="L339">    return builder.toString();</span>
  }

  private void toString(StringBuilder builder, int level) {
<span class="fc" id="L343">    builder.append(&quot;&lt;&quot;);</span>
<span class="fc" id="L344">    builder.append(name);</span>
<span class="fc bfc" id="L345" title="All 2 branches covered.">    for (Map.Entry&lt;Object, Object&gt; entry : attributes.entrySet()) {</span>
<span class="fc" id="L346">      builder.append(&quot; &quot;);</span>
<span class="fc" id="L347">      builder.append(entry.getKey());</span>
<span class="fc" id="L348">      builder.append(&quot;=\&quot;&quot;);</span>
<span class="fc" id="L349">      builder.append(entry.getValue());</span>
<span class="fc" id="L350">      builder.append(&quot;\&quot;&quot;);</span>
<span class="fc" id="L351">    }</span>
<span class="fc" id="L352">    List&lt;XNode&gt; children = getChildren();</span>
<span class="fc bfc" id="L353" title="All 2 branches covered.">    if (!children.isEmpty()) {</span>
<span class="fc" id="L354">      builder.append(&quot;&gt;\n&quot;);</span>
<span class="fc bfc" id="L355" title="All 2 branches covered.">      for (XNode child : children) {</span>
<span class="fc" id="L356">        indent(builder, level + 1);</span>
<span class="fc" id="L357">        child.toString(builder, level + 1);</span>
<span class="fc" id="L358">      }</span>
<span class="fc" id="L359">      indent(builder, level);</span>
<span class="fc" id="L360">      builder.append(&quot;&lt;/&quot;);</span>
<span class="fc" id="L361">      builder.append(name);</span>
<span class="fc" id="L362">      builder.append(&quot;&gt;&quot;);</span>
<span class="pc bpc" id="L363" title="1 of 2 branches missed.">    } else if (body != null) {</span>
<span class="fc" id="L364">      builder.append(&quot;&gt;&quot;);</span>
<span class="fc" id="L365">      builder.append(body);</span>
<span class="fc" id="L366">      builder.append(&quot;&lt;/&quot;);</span>
<span class="fc" id="L367">      builder.append(name);</span>
<span class="fc" id="L368">      builder.append(&quot;&gt;&quot;);</span>
    } else {
<span class="nc" id="L370">      builder.append(&quot;/&gt;&quot;);</span>
<span class="nc" id="L371">      indent(builder, level);</span>
    }
<span class="fc" id="L373">    builder.append(&quot;\n&quot;);</span>
<span class="fc" id="L374">  }</span>

  private void indent(StringBuilder builder, int level) {
<span class="fc bfc" id="L377" title="All 2 branches covered.">    for (int i = 0; i &lt; level; i++) {</span>
<span class="fc" id="L378">      builder.append(&quot;    &quot;);</span>
    }
<span class="fc" id="L380">  }</span>

  private Properties parseAttributes(Node n) {
<span class="fc" id="L383">    Properties attributes = new Properties();</span>
<span class="fc" id="L384">    NamedNodeMap attributeNodes = n.getAttributes();</span>
<span class="fc bfc" id="L385" title="All 2 branches covered.">    if (attributeNodes != null) {</span>
<span class="fc bfc" id="L386" title="All 2 branches covered.">      for (int i = 0; i &lt; attributeNodes.getLength(); i++) {</span>
<span class="fc" id="L387">        Node attribute = attributeNodes.item(i);</span>
<span class="fc" id="L388">        String value = PropertyParser.parse(attribute.getNodeValue(), variables);</span>
<span class="fc" id="L389">        attributes.put(attribute.getNodeName(), value);</span>
      }
    }
<span class="fc" id="L392">    return attributes;</span>
  }

  private String parseBody(Node node) {
<span class="fc" id="L396">    String data = getBodyData(node);</span>
<span class="fc bfc" id="L397" title="All 2 branches covered.">    if (data == null) {</span>
<span class="fc" id="L398">      NodeList children = node.getChildNodes();</span>
<span class="fc bfc" id="L399" title="All 2 branches covered.">      for (int i = 0; i &lt; children.getLength(); i++) {</span>
<span class="fc" id="L400">        Node child = children.item(i);</span>
<span class="fc" id="L401">        data = getBodyData(child);</span>
<span class="fc bfc" id="L402" title="All 2 branches covered.">        if (data != null) {</span>
<span class="fc" id="L403">          break;</span>
        }
      }
    }
<span class="fc" id="L407">    return data;</span>
  }

  private String getBodyData(Node child) {
<span class="fc bfc" id="L411" title="All 2 branches covered.">    if (child.getNodeType() == Node.CDATA_SECTION_NODE</span>
<span class="fc bfc" id="L412" title="All 2 branches covered.">        || child.getNodeType() == Node.TEXT_NODE) {</span>
<span class="fc" id="L413">      String data = ((CharacterData) child).getData();</span>
<span class="fc" id="L414">      data = PropertyParser.parse(data, variables);</span>
<span class="fc" id="L415">      return data;</span>
    }
<span class="fc" id="L417">    return null;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>